Ingestion Results for /Applications/XAMPP/xamppfiles/htdocs/tom_troc_web
Summary
Directory: tom_troc_web
Files analyzed: 37

Estimated tokens: 31.0k


Directory structure:
â””â”€â”€ tom_troc_web/
    â”œâ”€â”€ readme.md
    â”œâ”€â”€ account.php
    â”œâ”€â”€ addBook.php
    â”œâ”€â”€ book.php
    â”œâ”€â”€ books.php
    â”œâ”€â”€ createAccount.php
    â”œâ”€â”€ index.php
    â”œâ”€â”€ login.php
    â”œâ”€â”€ messages.php
    â”œâ”€â”€ styles.css
    â”œâ”€â”€ tomtroc.sql
    â”œâ”€â”€ updateBook.php
    â”œâ”€â”€ user.php
    â”œâ”€â”€ api/
    â”‚   â”œâ”€â”€ books.php
    â”‚   â”œâ”€â”€ commentaire.php
    â”‚   â”œâ”€â”€ conversations.php
    â”‚   â”œâ”€â”€ login.php
    â”‚   â”œâ”€â”€ message.php
    â”‚   â”œâ”€â”€ profile.php
    â”‚   â”œâ”€â”€ upload_avatar.php
    â”‚   â””â”€â”€ user.php
    â”œâ”€â”€ assets/
    â”œâ”€â”€ config/
    â”‚   â””â”€â”€ database.php
    â”œâ”€â”€ managers/
    â”‚   â”œâ”€â”€ conversationManager.php
    â”‚   â”œâ”€â”€ livreManager.php
    â”‚   â”œâ”€â”€ messageManager.php
    â”‚   â””â”€â”€ userManager.php
    â”œâ”€â”€ models/
    â”‚   â”œâ”€â”€ conversationModel.php
    â”‚   â”œâ”€â”€ livreModel.php
    â”‚   â”œâ”€â”€ messageModel.php
    â”‚   â””â”€â”€ userModel.php
    â”œâ”€â”€ services/
    â”‚   â”œâ”€â”€ books.js
    â”‚   â”œâ”€â”€ conversations.js
    â”‚   â”œâ”€â”€ createAccount.js
    â”‚   â”œâ”€â”€ login.js
    â”‚   â””â”€â”€ profile.js
    â””â”€â”€ templates/
        â”œâ”€â”€ footer.php
        â””â”€â”€ header.php


File Contents

===============================================
File: readme.md
===============================================

Application qui vise Ã  mettre en relation des particuliers qui souhaitent Ã©changer des livres afin de donner une seconde vie aux livres qui ne sont plus utilisÃ©s.


===============================================
File: account.php
===============================================

<?php 
    $selectedMenu = 'home';
?>

<?php include 'templates/header.php'; ?>


    <div class="my-account">
        <h1>Mon compte</h1>
        <div class="infos-perso">

            <div class="profile">
                <form class="avatar-form" action="api/upload_avatar.php" method="post" enctype="multipart/form-data">
                    <label class="avatar-wrapper">
                        <img src="assets/default-avatar.png" alt="Avatar" class="avatar-img">
                        <span class="avatar-edit">modifier</span>
                        <input type="file" name="avatar" accept="image/*" class="avatar-input" onchange="this.form.submit()">
                    </label>
                </form>
                <hr/>
                <span class="proprio"></span>
                <span class="created-at">Membre depuis</span>
                <span class="library">BibliothÃ¨que</span>
                <span class="my-books"></span>
            </div>
            <div class="edit-profile">
                <form class="form-edit">
                <h3 class="perso-info">Vos informations personnelles</h3>
                <label for="email">Adresse email</label>
                <input type="email" id="email" name="email"><br><br>

                <label for="password">Mot de passe</label>
                <input type="password" id="password" name="password"><br><br>

                <label for="username">Pseudo</label>
                <input type="username" id="username" name="username"><br><br>

                <button type="button" id="submit-creation">Enregister</button>
                </form>
            </div>
        </div>

        <div class="my-books">
          <button id="add-book-btn" class="add-book-btn">+ Ajouter un livre</button>
            <table class="books-table">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Titre</th>
                        <th>Auteur</th>
                        <th>Description</th>
                        <th>DisponibilitÃ©</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody id="user-books-list">
                    <!-- Les lignes seront gÃ©nÃ©rÃ©es en JS -->
                </tbody>

            </table>
        </div>
<script type="module">
    import { getConnectedUser, updateUser, getUserBooks, updateBook, deleteBook } from './services/profile.js';
    
    document.addEventListener("DOMContentLoaded", () => {
        //RÃ©cupÃ©ration de l'utilisateur connectÃ©
        getConnectedUser()
          .then((user) => {
            console.log(user);

            document.querySelector(".avatar-img").src = user.image || "assets/default-avatar.png";
            document.querySelector(".proprio").innerText = user.user_name;
            document.querySelector(".created-at").innerText = `Membre depuis le ${user.created_at}`;
            document.querySelector(".my-books").innerText = `${user.library} livre(s)`;

            document.querySelector("#email").value = user.email;
            document.querySelector("#password").value = "";
            document.querySelector("#username").value = user.user_name;

            // Une fois qu'on a le currentUser, on rÃ©cupÃ¨re ses lvres
            //RÃ©cupÃ©ration des livres de l'utilisateur
            const tbody = document.getElementById("user-books-list");

            getUserBooks(user.id)
              .then((books) => {
                console.log("Livres utilisateur :", books);
                tbody.innerHTML = "";

                books.forEach((book) => {
                  const tr = document.createElement("tr");
                  tr.classList.add("book-row");
                  tr.dataset.id = book.id;

                  tr.innerHTML = `
                    <td class="col-photo">
                        <img src="${book.image || ''}" alt="${book.titre || ''}" class="book-photo">
                    </td>

                    <td class="col-title">
                        <span class="book-title">${book.titre || ''}</span>
                    </td>

                    <td class="col-author">
                        <span class="book-author">${book.auteur || ''}</span>
                    </td>

                    <td class="col-description">
                        <span class="book-description">${book.description || ''}</span>
                    </td>

                    <td class="col-dispo">
                        <span class="book-dispo" data-dispo="${book.dispo}">
                            ${String(book.dispo) === "1" ? "Disponible" : "Indisponible"}
                        </span>
                    </td>

                    <td class="col-action">
                        <button type="button" class="edit-book">Ã‰diter</button>
                        <button type="button" class="delete-book">Supprimer</button>
                    </td>
                  `;
                    
                  tbody.appendChild(tr);
                });
              })
              .catch((error) => {
                console.error("Erreur lors de la rÃ©cupÃ©ration des livres", error);
              });

              //Gestion de la suppression et update
              tbody.addEventListener("click", (event) => {
                const target = event.target;
                const row = target.closest(".book-row");
                if (!row) return;

                const id = row.dataset.id;

                //SUPPRESSION
                if (target.classList.contains("delete-book")) {
                  if (!confirm("Voulez-vous vraiment supprimer ce livre ?")) {
                    return;
                  }

                  //suppression du livre
                  deleteBook(id)
                    .then((data) => {
                      console.log("Livre supprimÃ©", data);
                      row.remove();
                    })
                    .catch((error) => {
                      console.error("Erreur lors de la suppression du livre", error);
                      alert("Erreur lors de la suppression du livre.");
                    });
                }
              
              if (target.classList.contains("edit-book")) {
                  window.location.href = `updateBook.php?id=${id}`;
                }
              });
          })
          .catch((error) => {
            // Si pas de user connectÃ© â†’ on retourne vers la page de login
            window.location.href = "login.php";
          });

        //Gestion du bouton d'Ã©dition du profil
        document.getElementById("submit-creation").addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            
            updateUser(email, password, username)
              .then((data) => {
                console.log("Profil Ã©ditÃ© avec succÃ¨s", data);
                window.location.href = "account.php";
              })
              .catch((error) => {
                console.error("Erreur lors de la modification", error);
              });
        });
    });

    document.getElementById("add-book-btn").addEventListener("click", () => {
      window.location.href = "addBook.php";
    });

</script>

<?php include 'templates/footer.php'; ?>

===============================================
File: addBook.php
===============================================

<?php
    $selectedMenu = 'books';
?>

<?php include './templates/header.php'; ?>

<div class="update-book">
    <h1>Ajouter un livre</h1>
    <div class="img">
        <div class="book-image-form">
            <label class="book-image-wrapper">
                <img id="book-image" src="assets/placeholder-book.png" alt="Couverture du livre" />
                <span class="book-image-edit">Ajouter une photo</span>
                <input
                    type="file"
                    name="image"
                    id="image-input"
                    accept="image/*"
                    class="book-image-input">
            </label>
        </div>
    </div>

    <div class="form-update">
        <form id="create-book-form">
            <label for="titre">Titre</label>
            <input type="text" id="titre" name="titre">

            <label for="auteur">Auteur</label>
            <input type="text" id="auteur" name="auteur">

            <label for="description">Commentaire</label>
            <textarea id="description" name="description" rows="4"></textarea>

            <p class="error" style="color:#c44; font-size:13px; margin:4px 0 0;"></p>

            <button type="button" id="submit-book">Valider</button>
        </form>
    </div>
</div>

<script type="module">
    import { createBook } from './services/profile.js';

    const errorEl = document.querySelector('.error');
    const imageInput = document.getElementById('image-input');
    const bookImage  = document.getElementById('book-image');

    imageInput.addEventListener('change', () => {
        const file = imageInput.files[0];
        if (file) {
            bookImage.src = URL.createObjectURL(file);
        } else {
            bookImage.src = 'assets/placeholder-book.png';
        }
    });

    document.getElementById("submit-book").addEventListener('click', () => {
        const titre = document.getElementById('titre').value.trim();
        const auteur = document.getElementById('auteur').value.trim();
        const description = document.getElementById('description').value.trim();
        const dispo = "1";
        const imageFile = imageInput.files[0] || null;

        errorEl.innerText = '';

        if (!titre || !auteur || !description) {
            errorEl.innerText = "Veuillez remplir le titre, l'auteur et le commentaire.";
            return;
        }

        createBook(titre, auteur, description, "1", imageFile)
            .then((data) => {
                console.log("Livre crÃ©Ã© avec succÃ¨s", data);
                window.location.href = "account.php";
            })
            .catch((error) => {
                console.error("Erreur lors de la crÃ©ation", error);
                errorEl.innerText = "Une erreur est survenue lors de la crÃ©ation.";
            });
    });
</script>

<?php include './templates/footer.php'; ?>


===============================================
File: book.php
===============================================

<?php
    $selectedMenu = 'books';
?>

<?php include './templates/header.php'; ?>

<section class="book-detail">
  <div class="book-img"></div>

  <div class="book-info">
    <h3 class="titre"></h3>
    <h2 class="auteur"></h2>
    <hr>
    <h3>Description</h3>
    <p class="description"></p>
    <h3>PropriÃ©taire</h3>
    <p class="proprio"></p>
    <button type="button" id="send-msg">Envoyer un message</button>
  </div>
        
</section>


<script type="module">
  import { getBookById } from "./services/books.js";
  import { createConversationWithUserId } from "./services/conversations.js";

  document.addEventListener("DOMContentLoaded", () => {
    getBookById(new URLSearchParams(window.location.search).get('id')).then((book) => {      document.querySelector(".book-img").style.backgroundImage = `url(${book.image})`;
      document.querySelector(".titre").innerText = book.titre;
      document.querySelector(".auteur").innerText = "par" + " " + book.auteur;
      document.querySelector(".description").innerText = book.description;
      document.querySelector(".proprio").innerText = book.user_name;
      document.querySelector("#send-msg").addEventListener("click", () => {
        createConversationWithUserId(book.user_id).then((conv) => {
          console.log(conv)
          window.location.href = `messages.php?conversation_id=${conv.conversation_id}`;
        }).catch((err) => alert(err));
      })
    });

  });
</script>
<?php include './templates/footer.php'; ?>

===============================================
File: books.php
===============================================

<?php
    $selectedMenu = 'books';
?>

<?php include './templates/header.php'; ?>

<section class="book-content">

  <div class="search-bar">
    <span class="exchange-books">Nos livres Ã  l'Ã©change</span>
    <input type="text" placeholder=" ðŸ” Rechercher un livre" id="search-book" >
  </div>

  <ul id="books-list">
    <li class="book">
      <a href="">
        <img src="" alt="">
        <h3 class="titre"></h3>
        <h2 class="auteur"></h2>
        <span class="soldby">Vendu par:</span>
      </a>
    </li>
  </ul>

</section>


<script type="module">
  import { getAllBooks } from "./services/books.js";
  import { getConnectedUser } from "./services/profile.js";

  document.addEventListener("DOMContentLoaded", () => {
    Promise.all([getAllBooks(), getConnectedUser().catch(() => null)])
      .then(([books, user]) => {
        const booksList = document.getElementById("books-list");
        const template = booksList.querySelector(".book");

        books.filter(book => book.user_id !== user?.id).forEach((book) => {

        const bookCloneTemplate = template.cloneNode(true);
  
        bookCloneTemplate.querySelector("img").src = book.image;
        bookCloneTemplate.querySelector(".titre").textContent = book.titre;
        bookCloneTemplate.querySelector(".auteur").textContent = book.auteur;
        bookCloneTemplate.querySelector(".soldby").innerText = "Vendu par : " + book.user_name;
        bookCloneTemplate.querySelector("a").href = `book.php?id=${book.id}`;

        booksList.appendChild(bookCloneTemplate);
      });
    });

    document.getElementById("search-book").addEventListener("input", (e) => {
      const searchText = e.target.value.toLowerCase();

      document.querySelectorAll("#books-list .book:not(:first-child)").forEach((li) => {
        const title = li.querySelector(".titre")?.textContent.toLowerCase() || "";

        if (title.includes(searchText)) {
          li.style.display = "block";
        } else {
          li.style.display = "none";
        }
      });
    });

  });
</script>
<?php include './templates/footer.php'; ?>

===============================================
File: createAccount.php
===============================================

<?php
    $selectedMenu = 'login';
?>

<?php include './templates/header.php'; ?>

<!DOCTYPE html>
<html lang="en">
    <div class="connexion">
        <div class="form-connexion">
        <form>
            <span class="error"></span>
            <span class="connec">Inscription</span>

            <label for="username">Pseudo</label>
            <input type="username" id="username" name="username" required><br><br>

            <label for="email"> Adresse email</label>
            <input type="email" id="email" name="email" required><br><br>

            <label for="password">Mot de passe</label>
            <input type="password" id="password" name="password" required><br><br>

            <button type="button" id="submit-creation">S'inscrire</button>

            <span class="register">DÃ©jÃ  inscrit ? <a href="login.php">Connectez-vous</a></span>
        </form>
        </div>
        <div class="mask-group"></div>
    </div> 

    <script type="module">
        import { createAccount } from './services/createAccount.js';
        import { getConnectedUser } from './services/profile.js';

        const connectedUser = await getConnectedUser();

        if(connectedUser) {
            window.location.href = "account.php";
        }

        document.getElementById('submit-creation').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!username || !email || !password) {
                document.querySelector('.error').innerText = "Veuillez remplir tous les champs.";
                return;
            }

            createAccount(username, email, password)
            .then((data) => {
                console.log("Success", data);
                // Redirection vers la page d'accueil aprÃ¨s la crÃ©ation du compte
                window.location.href = "index.php";
            })
            .catch((error) => {
                console.error("Error:", error);
                document.querySelector('.error').innerText = "Pseudo dÃ©jÃ  prit. Veuillez en choisir un autre";
            });
        });

    </script>

<?php include './templates/footer.php'; ?>

===============================================
File: index.php
===============================================

<?php 
    $selectedMenu = 'home';
?>

<?php include 'templates/header.php'; ?>

<div class="container grey">
    <section class="content">
        <article>
            <h1>Rejoignez nos lecteurs passionnÃ©s</h1>
            <p>Donnez une nouvelle vie Ã  vos livres en les Ã©changeant avec d'autres amoureux de la lecture. Nous croyons en la magie du partage de connaissances et d'histoires Ã  travers les livres. </p>
            <button onclick="location.href='createAccount.php'">DÃ©couvrir</button>
        </article>
        <aside class="section-1">
            <img src="assets/section-1.jpg" alt="" />
        </aside>
        
    </section>
</div>

<div class="container">
    <h1>Les derniers livres ajoutÃ©s</h1>
    <section class="book-content">
        <ul id="books-list">
            <li class="book">
                <a href="">
                    <img src="" alt="">
                    <h3 class="titre"></h3>
                    <h2 class="auteur"></h2>
                    <span class="soldby">Vendu par:</span>
                </a>
            </li>
        </ul>
    </section>
    <button onclick="location.href='books.php'">Voir tous les livres</button>
</div>

    <div class="container grey">
        <h1>Comment Ã§a marche?</h1>
        <p class="how-subtitle">Ã‰changer des livres avec TomTroc câ€™est simple et amusant ! Suivez ces Ã©tapes pour commencer :</p>
        <div class="container-infos">
            <div class="info-card">
                <p>Inscrivez-vous gratuitement sur notre plateforme.</p>
            </div>
            <div class="info-card">
                 <p>Ajoutez les livres que vous souhaitez Ã©changer Ã  votre profil.</p>
            </div>
            <div class="info-card">
                 <p>Parcourez les livres disponibles chez d'autres membres.</p>
            </div>
            <div class="info-card">
                 <p>Proposez un Ã©change et discutez avec d'autres passionnÃ©s de lecture.</p>
            </div>
        </div>
        <button onclick="location.href='books.php'" class="variant">Voir tous les livres</button>
    </div>

   <div class="container-bandeau">
    <img src="assets/bandeau-img.png">
   </div>


    <div class="values-section">
    <div class="values-content">
        <h1>Nos valeurs</h1>

        <p class="values-text">
        Chez Tom Troc, nous mettons l'accent sur le partage, la dÃ©couverte et la communautÃ©.
        Nos valeurs sont ancrÃ©es dans notre passion pour les livres et notre dÃ©sir de crÃ©er
        des liens entre les lecteurs. Nous croyons en la puissance des histoires pour
        rassembler les gens et inspirer des conversations enrichissantes.
        </p>

        <p class="values-text">
        Notre association a Ã©tÃ© fondÃ©e avec une conviction profonde : chaque livre mÃ©rite
        d'Ãªtre lu et partagÃ©.
        </p>

        <p class="values-text">
        Nous sommes passionnÃ©s par la crÃ©ation d'une plateforme conviviale qui permet aux
        lecteurs de se connecter, de partager leurs dÃ©couvertes littÃ©raires et d'Ã©changer
        des livres qui attendent patiemment sur les Ã©tagÃ¨res.
        </p>

        <p class="values-signature">L'Ã©quipe Tom Troc</p>

        <img src="assets/vector.png" alt="Illustration" class="values-illustration">
    </div>
</div>



<script type="module">
    import { getAllBooks } from "./services/books.js";

    document.addEventListener("DOMContentLoaded", () => {
        getAllBooks().then((books) => {

            books.slice(0, 4).forEach((book) => {
                const booksList = document.getElementById("books-list");
                const bookCloneTemplate = booksList.querySelector(".book").cloneNode(true);
        
                bookCloneTemplate.querySelector("img").src = book.image;
                bookCloneTemplate.querySelector(".titre").textContent = book.titre;
                bookCloneTemplate.querySelector(".auteur").textContent = book.auteur;
                bookCloneTemplate.querySelector(".soldby").innerText = "Vendu par : " + book.user_name;
                bookCloneTemplate.querySelector("a").href = `book.php?id=${book.id}`;

                booksList.appendChild(bookCloneTemplate);
            });
        });
    });
</script>


<?php include 'templates/footer.php'; ?>

===============================================
File: login.php
===============================================

<?php
    session_start();
    $selectedMenu = 'login';
?>

<?php include './templates/header.php'; ?>

    <div class="connexion">
        <div class="form-connexion">
        <form>
            <span class="error"></span>
            <span class="connec">Connexion</span>
            <label for="email"> Adresse email</label>
            <input type="email" id="email" name="email" required><br><br>

            <label for="password">Mot de passe</label>
            <input type="password" id="password" name="password" required><br><br>

            <button type="button" id="submit-login">Se connecter</button>

            <span class="register">Pas de compte ? <a href="createAccount.php">Inscrivez-vous</a></span>
        </form>
        </div>
        <div class="mask-group"></div>
    </div>

    <script type="module">
        import { login } from './services/login.js';

        document.getElementById('submit-login').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                document.querySelector('.error').innerText = "Veuillez remplir tous les champs.";
                return;
            }

            login(email, password)
                .then((data) => {
                    console.log("Success:", data);
                    // Rediriger vers la page d'accueil aprÃ¨s la connexion rÃ©ussie
                    window.location.href = "index.php";
                })
                .catch((error) => {
                    console.error("Error:", error);
                    document.querySelector('.error').innerText = "Identifiant ou mot de passe incorrect";
                });
        });
    </script>

<?php include './templates/footer.php'; ?>

===============================================
File: messages.php
===============================================

<?php include './templates/header.php'; ?>

<section id="conversations">
  <aside>
    <h2 class="messaging-title">Messagerie</h2>
    <ul id="conversation-list"></ul>
  </aside>
  <article>
    <h2 id="conversation-title"></h2>
    <ul id="messages-list"></ul>
    <div class="message-input-bar">
      <input
        type="text"
        name="message"
        id="message"
        placeholder="Tapez votre message ici"
      />
      <button id="send-message">Envoyer</button>
    </div>
  </article>
</section>


<script type="module">
  import { 
    getAllConversations, 
    getAllMessagesForConversation, 
    createMessageForConversation, 
    getAllParticipantsByConversationId 
  } from "./services/conversations.js";
  import { getConnectedUser } from "./services/profile.js";

  const DEFAULT_AVATAR = "assets/default-avatar.png";

  function formatMessageTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString("fr-FR", {
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function formatMessageDate(dateString) {
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    return `${day}/${month}`;
  }

  function truncateText(text, maxLength = 40) {
    if (!text) return "";
    if (text.length <= maxLength) return text;
    return text.slice(0, maxLength - 1) + "â€¦";
}


  document.addEventListener("DOMContentLoaded", () => {
    Promise.all([
        getAllConversations(),
        getConnectedUser()
    ])
    .then((values) => {
      const conversations = values[0];
      const connectedUser = values[1];

      if(!connectedUser) {
        window.location.href = "login.php";
      }

      const convList = document.getElementById('conversation-list');

      //Liste des conversations (colonne de gauche)
      conversations.forEach((conv) => {
        const elem = document.createElement("li");
        elem.setAttribute("id", "conv-" + conv.id);

        //Calcul de l'heure du dernier message (ou de la crÃ©ation de la conv)
        const lastDate  = conv.last_message_at || conv.created_at;
        const timeLabel = lastDate ? formatMessageTime(lastDate) : "";

        //AperÃ§u du dernier message
        const previewRaw = conv.last_message_content || "";
        const preview    = truncateText(previewRaw, 40);

        //Structure HTML de base : avatar + nom + heure
        elem.innerHTML = `
          <img class="conv-avatar" src="${DEFAULT_AVATAR}" alt="Avatar" />
          <div class="conv-text">
            <span class="conv-name">Conversation ${conv.id}</span>
            <span class="conv-preview">${preview}</span>
          </div>
          <span class="conv-time">${timeLabel}</span>
        `;

        //On rÃ©cupÃ¨re les participants pour afficher le bon nom + avatar
        getAllParticipantsByConversationId(conv.id).then((participants) => {
          // participants est un tableau d'objets { id, username, image }
          const other = participants.find((p) => p.id !== connectedUser.id);

          const avatarImg = elem.querySelector(".conv-avatar");
          const nameSpan  = elem.querySelector(".conv-name");

          if (other) {
            nameSpan.textContent = other.username;
            avatarImg.src = other.image || DEFAULT_AVATAR;
            avatarImg.alt = other.username;
          } else {
            nameSpan.textContent = "Conversation " + conv.id;
          }
        });

        //Quand on clique sur la conv on change l'URL avec le bon conversation_id
        elem.addEventListener("click", () => {
          const url = new URL(window.location.href);
          url.searchParams.set("conversation_id", conv.id);
          window.location.href = url.toString();
        });

        convList.appendChild(elem);
      });

      //Conversation sÃ©lectionnÃ©e (colonne de droite)
      const selectedConv = new URLSearchParams(window.location.search).get('conversation_id');

      if (selectedConv) {
        // RÃ©cupÃ©ration du nom + avatar du participant pour le titre
        getAllParticipantsByConversationId(selectedConv)
          .then((participants) => {
            const other = participants.find((p) => p.id !== connectedUser.id);
            const titleEl = document.getElementById("conversation-title");

            if (other) {
              titleEl.innerHTML = `
                <img class="conversation-avatar" src="${other.image || DEFAULT_AVATAR}" alt="${other.username}" />
                <span>${other.username}</span>
              `;
            } else {
              titleEl.textContent = "Conversation";
            }
          });

        // Marquer la conv active dans la liste
        const elemSelected = document.getElementById("conv-" + selectedConv);
        if (elemSelected) {
          elemSelected.classList.add('active');
        }

        // Charger les messages de la conversation
        getAllMessagesForConversation(selectedConv).then((messages) => {
          const messageList = document.getElementById('messages-list');
          messageList.innerHTML = "";

          messages.forEach(message => {
            const messageElem = document.createElement('li');
            messageElem.innerHTML = `
              <span class="content">${message.content}</span>
              <span class="time">
                ${formatMessageDate(message.created_at)} â€¢ ${formatMessageTime(message.created_at)}
              </span>
            `;

            if (message.sender_id === connectedUser.id) {
              messageElem.classList.add('me');
            }

            messageList.appendChild(messageElem);
          });

          // Scroll en bas aprÃ¨s chargement des messages
          messageList.scrollTop = messageList.scrollHeight;
        });
      }

      //Envoi d'un message
      document.getElementById("send-message").addEventListener("click", () => {
        const input       = document.getElementById('message');
        const messageText = input.value.trim();
        const selectedConv = new URLSearchParams(window.location.search).get('conversation_id');

        if (messageText && selectedConv) {
          createMessageForConversation(selectedConv, messageText).then(() => {
            const messageList  = document.getElementById('messages-list');
            const messageElem  = document.createElement('li');

            messageElem.innerHTML = `
              <span class="content">${messageText}</span>
              <span class="time">
                ${formatMessageDate(new Date())} â€¢ ${formatMessageTime(new Date())}
              </span>
            `;

            messageElem.classList.add('me');

            messageList.appendChild(messageElem);
            input.value = '';

            // scroll automatique
            messageList.scrollTop = messageList.scrollHeight;
          }).catch((err) => {
            console.error(err);
          });
        }
      });
    }).catch(err => {
        window.location.href = "login.php";
    });
  });
</script>


<?php include './templates/footer.php'; ?>

===============================================
File: styles.css
===============================================

:root {
  --primary: rgb(0, 172, 102);
  --neutral: rgb(245, 243, 239);
  --background: #faf9f7;
  --neutral-pastel: rgb(250, 249, 247);
  --text: rgb(41, 41, 41);
}

* {
  box-sizing: border-box;
}

/** GLOBAL SECTION STYLE **/

html,
body {
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  font-size: 14px;
  height: 100%;
}

body {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.error {
  color: darkred;
}

button {
  background-color: var(--primary);
  color: #fff;
  border: 1px solid var(--primary);
  border-radius: 12px;
  padding: 1rem 2rem;
}

button.variant,
button:hover {
  background-color: var(--neutral);
  color: var(--primary);
  border: 1px solid var(--primary);
}

header {
  width: 100%;
  height: 64px;
  flex: 0 0 auto;
  background-color: var(--neutral);
  color: var(--text);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

header nav {
  width: clamp(300px, 90vw, 1280px);
  display: flex;
  justify-content: space-between;
}

header nav img {
  height: 50px;
  margin-right: 3rem;
}

header nav ul {
  margin: 0;
  display: flex;
  gap: 2rem;
}

header nav ul li {
  list-style-type: none;
  display: flex;
  align-items: center;
}

header nav ul li#login-button,
header nav ul li#logout-button {
  display: none;
}

header nav ul li a {
  text-decoration: none;
  color: var(--text);
}

header nav ul li a.active,
header nav ul li a:hover {
  font-weight: bold;
}

main {
  flex: 1 1 100%;
  overflow: auto;
  background-color: var(--background);
}

/** ACCUEIL SECTION STYLE **/

section {
  width: clamp(300px, 90vw, 980px);
  padding: 0 24px;
}

.content {
  display: flex;
  height: fit-content;
}

.container.grey {
  background-color: var(--neutral);
}

.container {
  padding: 60px 0;
  display: flex;
  align-items: center;
  flex-direction: column;
}

.container h1 {
  align-self: unset;
}

article {
  display: flex;
  flex: 0 0 50%;
  flex-direction: column;
  padding: 3rem 2rem;
  justify-content: center;
  gap: 1rem;
}

article h1 {
  margin: 0;
}

article button {
  width: fit-content;
}

aside {
  display: flex;
  flex: 0 0 50%;
  align-items: center;
  justify-content: center;
}

aside img {
  max-width: 100%;
}

.global-container {
  background-color: var(--neutral);
}

.container h1 {
  display: flex;
  justify-content: center;
  margin-top: 5rem;
}

.how-it-works {
  padding: 80px 20px 120px;
  text-align: center;
}

.how-subtitle {
  max-width: 640px;
  margin: 0 auto 60px;
  font-size: 18px;
  line-height: 1.5;
  color: #444;
}

.container-infos {
  max-width: 1100px;
  margin: 0 auto 60px;
  display: flex;
  justify-content: center;
  gap: 32px;
}

.info-card {
  background: #ffffff;
  border-radius: 16px;
  padding: 40px 32px;
  min-width: 220px;
  max-width: 260px;
  min-height: 160px;

  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.info-card p {
  margin: 0;
  font-size: 16px;
  line-height: 1.4;
  color: #333;
}

.values-section {
  background-color: #f5f3ef;
  padding: 120px 20px 140px;
}

.values-content {
  max-width: 720px;
  margin: 0 auto;
}

.values-content h1 {
  font-size: 40px;
  font-weight: 500;
  margin: 0 0 32px;
}

.values-text {
  font-size: 18px;
  line-height: 1.7;
  color: #333;
  margin: 0 0 18px;
}

.values-signature {
  margin-top: 28px;
  font-size: 14px;
  font-style: italic;
  color: #a0a0a0;
}

.values-illustration {
  display: block;
  margin: 60px 0 0 auto;
  max-width: 220px;
}

/** BOOK SECTION STYLE **/

.book-content {
  width: clamp(300px, 90vw, 980px);
  margin: 60px auto 80px;
  padding: 0 24px;
}

.search-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 24px;
  margin-bottom: 40px;
}

.exchange-books {
  font-size: 32px;
  font-weight: 500;
}

.search-bar input {
  flex: 0 0 320px;
  max-width: 100%;
}

#books-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 32px;
}

li.book:first-child {
  display: none;
}

.book {
  background-color: #fff;
}

.book a {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  text-decoration: none;
  color: var(--text);
}

.book img {
  width: 100%;
  height: 230px;
  object-fit: cover;
  display: block;
}

.book .titre {
  margin: 16px 16px 4px;
  font-size: 16px;
  font-weight: 600;
}

.book .auteur {
  margin: 0 16px 12px;
  font-size: 14px;
  font-weight: 400;
  color: #a6a4a4;
}

.book .soldby {
  display: block;
  font-style: italic;
  margin: 0 16px 16px;
  font-size: 12px;
  color: #a6a4a4;
}

/** BOOK DETAIL SECTION STYLE **/

.book-detail {
  margin: 40px auto 80px;
  border-radius: 24px;
  overflow: hidden;
  display: flex;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.06);
  width: clamp(300px, 90vw, 1280px);
  min-height: 100vh;
}

.book-img {
  flex: 1.1;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  min-height: 520px;
}

.book-info {
  flex: 1;
  padding: 48px 64px;
  display: flex;
  flex-direction: column;
}

.book-info .titre {
  font-size: 36px;
  font-weight: 500;
  margin: 0 0 8px;
}

.book-info .auteur {
  font-size: 16px;
  font-weight: 400;
  margin: 0 0 24px;
}

.book-info hr {
  border: none;
  border-top: 1px solid;
  margin: 0 0 32px;
}

.book-info h3 {
  font-size: 12px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin: 0 0 12px;
}

.book-info .description {
  font-size: 14px;
  line-height: 1.7;
  margin: 0 0 32px;
}

.book-info .proprio {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  border-radius: 999px;
  padding: 10px 18px 10px 10px;
  font-size: 14px;
  margin: 0 0 40px;
}

.book-info .proprio::before {
  content: "";
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: inline-block;
}

.book-info #send-msg:hover {
  background-color: #31935b;
  box-shadow: 0 10px 24px rgba(60, 168, 106, 0.4);
  transform: translateY(-1px);
}

.book-info #send-msg:active {
  transform: translateY(0);
  box-shadow: 0 5px 16px rgba(60, 168, 106, 0.3);
}

/** SEND MSG BOOK SECTION STYLE **/

.user-profile-page {
  display: flex;
  height: 100%;
  justify-content: center;
  align-items: center;
}

.user-profile-layout {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  box-sizing: border-box;
  width: clamp(300px, 90vw, 1280px);
}

.user-profile-card {
  width: 330px;
  max-height: 550px;
  padding: 48px 40px;
  background: white;
  border-radius: 24px;
  text-align: center;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.06);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.user-profile-avatar-wrapper {
  width: 140px;
  height: 140px;
  border-radius: 50%;
  overflow: hidden;
  display: inline-block;
}

.user-profile-avatar {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.user-profile-separator {
  margin: 30px 0;
  border: none;
  border-top: 1px solid #efefef;
}

.user-profile-username {
  display: block;
  font-size: 22px;
  font-weight: 500;
  margin-bottom: 4px;
}

.user-profile-created {
  display: block;
  color: #777;
  font-size: 14px;
  margin-bottom: 32px;
}

.user-profile-library-label {
  display: block;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: #999;
}

.user-profile-books-count {
  display: block;
  font-size: 14px;
  margin-bottom: 32px;
}

/* ---- TABLE LIVRES ---- */
.user-books-container {
  flex: 1;
  background: white;
  border-radius: 24px;
  overflow: hidden;
}

.user-books-table {
  width: 100%;
  border-collapse: collapse;
}

.user-books-table thead th {
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-size: 11px;
  color: #a0a7b2;
  padding: 2rem 0 1rem 0;
}

.user-book-row td {
  padding: 18px 24px;
}

/* Zebra */
.user-book-row.even {
  background: #f6fafc;
}

.user-book-row.odd {
  background: white;
}

/* Images */
.user-books-photo {
  width: 70px;
  height: 90px;
  border-radius: 4px;
  object-fit: cover;
}

.user-books-desc {
  font-size: 13px;
  line-height: 1.5;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

/** ACCOUNT DETAIL SECTION STYLE **/

.my-account {
  width: clamp(300px, 90vw, 980px);
  margin: 60px auto 80px;
  padding: 0 24px;
  display: flex;
  flex-direction: column;
  height: 100%;
  gap: 2rem;
  background-color: var(--background);
}

.infos-perso {
  display: grid;
  grid-template-columns: 1.1fr 1fr;
  gap: 2rem;
}

.profile,
.edit-profile,
.my-account > .my-books {
  background: #ffffff;
  border-radius: 24px;
  padding: 2.5rem 3rem;
}

.profile {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding-top: 8rem;
}

h1 {
  align-self: flex-start;
  margin: 0 0 1.5rem;
  font-size: 2rem;
  font-weight: 500;
}

.avatar-form {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.avatar-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  gap: 0.4rem;
}

.avatar-img {
  width: 96px;
  height: 96px;
  border-radius: 50%;
  object-fit: cover;
  display: block;
}

.avatar-edit {
  font-size: 0.85rem;
  color: #7a7a7a;
  text-decoration: underline;
}

.avatar-input {
  display: none;
}

.profile hr {
  width: 60%;
  margin: 1.5rem 0;
  border: none;
  border-top: 1px solid;
}

.profile .proprio {
  font-size: 1.3rem;
  font-weight: 500;
  margin-bottom: 0.25rem;
}

.profile .created-at {
  font-size: 0.9rem;
  color: #8b8b8b;
  margin-bottom: 1.5rem;
}

.profile .library {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: #a0a0a0;
  margin-bottom: 0.25rem;
}

.profile span.my-books {
  font-size: 0.95rem;
  color: #333333;
}

.edit-profile .form-edit {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.form-edit .perso-info {
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: #9c9c9c;
  margin: 0 0 1.5rem;
}

.form-edit label {
  font-size: 0.85rem;
  color: #555555;
  margin-bottom: 0.25rem;
}

.form-edit input {
  width: 100%;
  padding: 0.75rem 0.9rem;
  border-radius: 10px;
  border: 1px solid #e3e3e3;
  background-color: #f7f8f8;
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.form-edit input:focus {
  border-color: #46a564;
  box-shadow: 0 0 0 1px rgba(70, 165, 100, 0.25);
}

.my-account > .my-books {
  padding: 1.75rem 2.5rem;
}

.my-account > .my-books p {
  margin: 0;
  font-size: 0.9rem;
  color: #6b7280;
}

.my-books {
  margin-top: 40px;
  background-color: #f9fafb;
  border-radius: 24px;
  padding: 24px 32px 32px;
}

.books-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 14px;
}

.books-table thead th {
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 0.08em;
  padding: 16px 12px;
  text-align: left;
  color: #777;
}

.books-table td {
  padding: 20px 12px;
  vertical-align: middle;
}

.books-table tbody tr:nth-child(even) {
  background-color: #f3f7fc;
}

.books-table .col-photo {
  width: 100px;
}

.books-table .book-photo {
  display: block;
  width: 72px;
  height: 96px;
  object-fit: cover;
  border-radius: 4px;
}

.books-table .col-title {
  width: 20%;
  font-weight: 500;
}

.books-table .col-author {
  width: 18%;
  color: #444;
}

.books-table .col-description {
  width: 35%;
  color: #555;
}

.books-table .book-description {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.dispo-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 12px;
  color: #fff;
}

.dispo-badge.dispo {
  background-color: #45c19f;
}

.dispo-badge.indispo {
  background-color: #cc6060;
}

.books-table .col-action {
  width: 14%;
  white-space: nowrap;
}

.edit-book,
.delete-book {
  background: none;
  border: none;
  padding: 0;
  font: inherit;
  cursor: pointer;
}

.edit-book {
  color: #111;
  margin-right: 16px;
  text-decoration: underline;
}

.delete-book {
  color: #c0392b;
  text-decoration: underline;
}

/** UPDATE BOOK SECTION STYLE **/

.update-book {
  max-width: 1100px;
  margin: 40px auto;
  padding: 32px 40px 40px;
  border-radius: 24px;
  display: grid;
  grid-template-columns: 1.4fr 1fr;
  column-gap: 48px;
  row-gap: 24px;
  background: white;
}

.update-book h1 {
  grid-column: 1 / -1;
  margin: 0 0 24px;
  font-size: 26px;
  font-weight: 600;
  color: #222;
}

.update-book .img {
  border-radius: 20px;
  overflow: hidden;
  background-color: #e6ebf2;
}

.book-image-form {
  width: 100%;
}

.book-image-wrapper {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  cursor: pointer;
}

.update-book #book-image {
  display: block;
  width: 100%;
  height: 420px;
  object-fit: cover;
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}

.book-image-input {
  display: none;
}

.book-image-edit {
  display: inline-block;
  margin: 10px 0 16px 16px;
  font-size: 13px;
  text-decoration: underline;
  transition: color 0.15s ease;
}

.book-image-wrapper:hover #book-image {
  filter: brightness(0.97);
}

.book-image-wrapper:hover .book-image-edit {
  color: #111;
}

.form-update form {
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.form-update br {
  display: none;
}

.form-update label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: #555;
  margin-bottom: 4px;
}

.form-update input[type="text"],
.form-update textarea,
.form-update select {
  width: 100%;
  border-radius: 10px;
  border: 1px solid #d9e1eb;
  background-color: #f3f7fc;
  padding: 10px 12px;
  font-size: 14px;
  color: #222;
  outline: none;
  box-sizing: border-box;
}

.form-update textarea {
  min-height: 160px;
  resize: vertical;
}

.form-update select {
  height: 40px;
}

#submit-update {
  align-self: flex-end;
  margin-top: 12px;
  padding: 10px 32px;
  border-radius: 999px;
  border: none;
  background-color: #209653;
  color: #fff;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.15s ease, transform 0.1s ease;
}

#submit-update:hover {
  background-color: #187443;
}

#submit-update:active {
  transform: scale(0.98);
}

/** LOGIN SECTION STYLE **/

.connexion {
  display: flex;
  height: 100%;
  background-color: var(--background);
}

.form-connexion {
  display: flex;
  flex: 1 1 auto;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.connec {
  font-size: 36px;
  margin-bottom: 50px;
}

.connexion label {
  margin-bottom: 10px;
}

input {
  padding: 14px 16px;
  border-radius: 10px;
  border: 1px solid #e6e6e6;
  background-color: #ffffff;
  font-size: 15px;
  outline: none;
}

.register {
  font-size: 14px;
  margin-top: 30px;
}

.connexion form {
  display: flex;
  box-sizing: border-box;
  height: fit-content;
  align-items: stretch;
  overflow: hidden;
  min-width: 300px;
  flex-direction: column;
}

.mask-group {
  display: flex;
  flex: 1 1 auto;
  align-items: center;
  justify-content: center;
}

.mask-group {
  background-image: url("assets/mask_group.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

/** CONVERSATIONS SECTION STYLE **/

#conversations {
  display: flex;
  width: 100%;
  height: 100%;
  background-color: var(--neutral);
  overflow: hidden;
  align-items: stretch;
}

#conversations aside {
  background-color: var(--background);
  width: 320px;
  min-width: 280px;
  max-width: 340px;
  display: flex;
  flex-direction: column;
  padding: 24px 0;
  border-right: 1px solid #e5e5e5;
}

#conversations aside .messaging-title {
  font-size: 1.4rem;
  font-weight: 600;
  margin: 0 24px 20px;
}

#conversation-list {
  list-style: none;
  margin: 0;
  padding: 0;
  flex: 1 1 auto;
  overflow-y: auto;
}

#conversation-list li {
  display: flex;
  align-items: center;
  padding: 10px 18px;
  gap: 10px;
  cursor: pointer;
  border-radius: 8px;
  margin: 0 10px 4px;
  transition: background-color 0.15s ease, box-shadow 0.15s ease;
}

#conversation-list li .conv-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  background-color: #ddd;
  flex-shrink: 0;
}

#conversation-list li .conv-text {
  display: flex;
  flex-direction: column;
  flex: 1 1 auto;
}

#conversation-list li .conv-name {
  font-weight: 500;
  font-size: 0.95rem;
  color: #333;
}

#conversation-list li .conv-time {
  font-size: 0.8rem;
  color: #999;
  margin-left: 8px;
}

#conversation-list li:hover {
  background-color: #f5f5f5;
}

#conversation-list li.active {
  background-color: #f0f2ff;
  box-shadow: inset 3px 0 0 #2db566;
}

#conversations article {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  padding: 24px 40px 32px;
}

#conversation-title {
  display: flex;
  align-items: center;
  font-size: 1rem;
  font-weight: 600;
  margin: 0 0 16px;
  gap: 10px;
}

#conversation-title .conversation-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  object-fit: cover;
  background-color: #ddd;
}

#messages-list {
  list-style: none;
  margin: 0;
  padding: 16px 0;
  flex: 1 1 auto;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#messages-list li {
  max-width: 60%;
  padding: 10px 14px;
  background-color: #ffffff;
  border-radius: 8px;
  font-size: 0.95rem;
  color: #333;
  display: flex;
  flex-direction: column;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
}

#messages-list li .content {
  margin-bottom: 4px;
}

#messages-list li .time {
  font-size: 0.75rem;
  color: #999;
  align-self: flex-end;
}

#messages-list li.me {
  align-self: flex-end;
  background-color: #e9f4ff;
}

.message-input-bar {
  display: flex;
  gap: 1rem;
  padding-top: 16px;
}

.message-input-bar #message {
  flex: 1 1 auto;
  border: none;
  border-radius: 999px;
  padding: 14px 18px;
  font-size: 0.95rem;
  background-color: #ffffff;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  outline: none;
}

.message-input-bar #message::placeholder {
  color: #b3b3b3;
}

.message-input-bar #send-message {
  flex: 0 0 auto;
  min-width: 130px;
  border: none;
  border-radius: 999px;
  padding: 0 24px;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  background-color: #2db566;
  color: #ffffff;
  transition: background-color 0.15s ease, transform 0.05s ease;
}

.message-input-bar #send-message:hover {
  background-color: #27a35c;
}

.message-input-bar #send-message:active {
  transform: scale(0.98);
}

/** FOOTER SECTION STYLE **/

footer {
  width: 100%;
  height: 64px;
  flex: 0 0 auto;
  background-color: var(--neutral);
  color: var(--text);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 3rem;
  padding: 0 3rem;
  box-sizing: border-box;
}

footer ul {
  width: clamp(300px, 90vw, 1280px);
  display: flex;
  margin: 0;
  gap: 2rem;
  justify-content: flex-end;
}

footer ul li {
  list-style-type: none;
  color: var(--text);
}


===============================================
File: tomtroc.sql
===============================================

-- CrÃ©e la base si elle n'existe pas
CREATE DATABASE IF NOT EXISTS tomtroc
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE tomtroc;

-- On supprime les tables si elles existent dÃ©jÃ 
DROP TABLE IF EXISTS commentaire;
DROP TABLE IF EXISTS message;
DROP TABLE IF EXISTS conversation_user;
DROP TABLE IF EXISTS conversation;
DROP TABLE IF EXISTS livre;
DROP TABLE IF EXISTS user;

-- ===========================================
-- TABLE : user
-- ===========================================
CREATE TABLE user (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(100) NOT NULL UNIQUE,
  email VARCHAR(255) NOT NULL UNIQUE,
  image VARCHAR(255) DEFAULT NULL,
  password VARCHAR(255) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- ===========================================
-- TABLE : livre
-- ===========================================
CREATE TABLE livre (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  titre VARCHAR(255) NOT NULL,
  auteur VARCHAR(255) NOT NULL,
  image VARCHAR(255) DEFAULT NULL,
  description TEXT,
  dispo TINYINT(1) NOT NULL DEFAULT 1,
  user_id INT UNSIGNED NOT NULL,
  CONSTRAINT fk_livre_user
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- ===========================================
-- TABLE : conversation
-- Une conversation (thread) qui regroupe des messages
-- ===========================================
CREATE TABLE conversation (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- ===========================================
-- TABLE : conversation_user
-- Table de jointure N-N entre conversation et user
-- Un user peut participer Ã  plusieurs conversations
-- Une conversation peut avoir 1..n users
-- ===========================================
CREATE TABLE conversation_user (
  conversation_id INT UNSIGNED NOT NULL,
  user_id INT UNSIGNED NOT NULL,
  joined_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

  PRIMARY KEY (conversation_id, user_id),

  CONSTRAINT fk_conv_user_conversation
    FOREIGN KEY (conversation_id) REFERENCES conversation(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE,

  CONSTRAINT fk_conv_user_user
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- ===========================================
-- TABLE : message
-- Un message appartient Ã  UNE conversation et UN user
-- ===========================================
CREATE TABLE message (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  conversation_id INT UNSIGNED NOT NULL,
  user_id INT UNSIGNED NOT NULL,
  content TEXT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  read_at DATETIME DEFAULT NULL,

  CONSTRAINT fk_message_conversation
    FOREIGN KEY (conversation_id) REFERENCES conversation(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE,

  CONSTRAINT fk_message_user
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- ===========================================
-- TABLE : commentaire
-- (inchangÃ©e, toujours liÃ©e Ã  user + livre)
-- ===========================================
CREATE TABLE commentaire (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  contenu TEXT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  user_id INT UNSIGNED NOT NULL,
  livre_id INT UNSIGNED DEFAULT NULL,
  CONSTRAINT fk_commentaire_user
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT fk_commentaire_livre
    FOREIGN KEY (livre_id) REFERENCES livre(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci;

-- ===========================================
-- DONNÃ‰ES DES UTILISATEURS
-- ===========================================

-- Utilisateur Chris
INSERT INTO user (username, email, image, password, created_at) VALUES
('chris', 'chris@example.com', 'assets/chris.jpg', 'chris', '2023-04-12 10:15:00');

SET @chris_id = LAST_INSERT_ID();

-- Utilisateur Alex
INSERT INTO user (username, email, image, password, created_at) VALUES
('alex', 'alex@example.com', 'assets/alex.jpg', 'alex', '2023-06-03 18:40:00');

SET @alex_id = LAST_INSERT_ID();

-- ===========================================
-- LIVRES DE CHRIS (DESCRIPTIONS LONGUES)
-- ===========================================
INSERT INTO livre (titre, auteur, image, description, dispo, user_id) VALUES
(
  'Le Petit Prince',
  'Antoine de Saint-ExupÃ©ry',
  'assets/petitprince.jpg',
  'â€œLe Petit Princeâ€ est un livre que j''ai relu plusieurs fois Ã  diffÃ©rents moments de ma vie, et Ã  chaque lecture j''y ai trouvÃ© quelque chose de nouveau. Quand je l''ai dÃ©couvert plus jeune, je l''ai surtout vÃ©cu comme un joli conte poÃ©tique. En le relisant adulte, certaines phrases m''ont littÃ©ralement arrÃªtÃ© dans ma lecture tant elles rÃ©sonnaient avec mon quotidien, ma faÃ§on de voir les relations et ce que l''on considÃ¨re comme important. Ce que j''aime particuliÃ¨rement, c''est la maniÃ¨re dont le livre parle de l''amitiÃ©, de la responsabilitÃ© et du fait de prendre soin des autres sans jamais Ãªtre lourd ou moralisateur. C''est une histoire courte, mais elle laisse une impression durable, un peu comme une petite lumiÃ¨re qui continue de briller longtemps aprÃ¨s avoir refermÃ© le livre.',
  1,
  @chris_id
),

(
  '1984',
  'George Orwell',
  'assets/1984.jpg',
  'â€œ1984â€ a Ã©tÃ© une lecture assez Ã©prouvante, mais dans le bon sens du terme. DÃ¨s les premiÃ¨res pages, j''ai ressenti une forme de malaise, cette impression d''Ãªtre enfermÃ© dans un monde oÃ¹ chaque geste, chaque pensÃ©e est surveillÃ©. Le roman m''a fait rÃ©flÃ©chir Ã  la place de la libertÃ© individuelle, Ã  la manipulation de l''information et Ã  la faÃ§on dont les rÃ©gimes autoritaires peuvent dÃ©former la rÃ©alitÃ©. Ce n''est pas un livre que l''on lit pour se dÃ©tendre, mais plutÃ´t un texte qui bouscule et qui reste en tÃªte longtemps. AprÃ¨s l''avoir terminÃ©, j''ai eu du mal Ã  passer Ã  autre chose : certaines scÃ¨nes et certaines phrases reviennent encore rÃ©guliÃ¨rement quand j''entends parler de politique, de mÃ©dias ou de contrÃ´le social. C''est un classique qui mÃ©rite clairement sa rÃ©putation, mÃªme si on ne ressort pas indemne de sa lecture.',
  0,
  @chris_id
),

(
  'Dune',
  'Frank Herbert',
  'assets/dune.jpg',
  'â€œDuneâ€ est un vÃ©ritable voyage, autant par son univers que par la profondeur de ses personnages. Au dÃ©but, j''ai mis un peu de temps Ã  entrer dans l''histoire, mais une fois plongÃ© dans l''atmosphÃ¨re d''Arrakis, j''ai eu du mal Ã  lÃ¢cher le livre. Ce qui m''a le plus marquÃ©, c''est la richesse du monde : les enjeux politiques, les luttes de pouvoir entre les maisons, la place de l''Ã©cologie, la relation au dÃ©sert et Ã  l''Ã©piceâ€¦ tout est dense mais extrÃªmement bien construit. J''ai aussi beaucoup aimÃ© suivre l''Ã©volution de Paul et la maniÃ¨re dont il se retrouve pris entre son destin, les attentes des autres et ses propres doutes. C''est un livre qui demande un peu d''attention, mais qui rÃ©compense largement le lecteur avec une histoire Ã©pique, intelligente et fascinante.',
  1,
  @chris_id
);

-- ===========================================
-- LIVRES D'ALEX
-- ===========================================
INSERT INTO livre (titre, auteur, image, description, dispo, user_id) VALUES
(
  'Harry Potter Ã  l''Ã©cole des sorciers',
  'J.K. Rowling',
  'assets/hp1.jpg',
  'Ce premier tome de â€œHarry Potterâ€ est l''un de ceux qui m''ont donnÃ© le goÃ»t de la lecture quand j''Ã©tais plus jeune...',
  1,
  @alex_id
),

(
  'Le Hobbit',
  'J.R.R. Tolkien',
  'assets/hobbit.jpg',
  'â€œLe Hobbitâ€ a pour moi le charme d''un grand conte d''aventure...',
  1,
  @alex_id
);

-- ===========================================
-- COMMENTAIRES ENTRE CHRIS ET ALEX
-- ===========================================
INSERT INTO commentaire (contenu, user_id, livre_id)
VALUES ('Salut Alex, tu as dÃ©jÃ  lu Dune ? Tu en as pensÃ© quoi ?', @chris_id, 3);

INSERT INTO commentaire (contenu, user_id, livre_id)
VALUES ('Oui ! Câ€™est un roman incroyable, super riche. Tu veux le lire ?', @alex_id, 3);

INSERT INTO commentaire (contenu, user_id, livre_id)
VALUES ('Grave ! Je suis super motivÃ©. Il est toujours dispo Ã  l''Ã©change ?', @chris_id, 3);

INSERT INTO commentaire (contenu, user_id, livre_id)
VALUES ('Ouais il est dispo ! Si tu veux je peux te le passer cette semaine.', @alex_id, 3);


===============================================
File: updateBook.php
===============================================

<?php
    $selectedMenu = 'books';

    // RÃ©cupÃ©rer l'id du livre depuis l'URL
    $bookId = $_GET['id'] ?? null;
    if (!$bookId) {
        // pas d'id â†’ on retourne Ã  la liste
        header('Location: account.php');
        exit;
    }
?>

<?php include './templates/header.php'; ?>

<div class="update-book">
    <h1>Modifier les informations</h1>
        <div class="img">
    <form class="book-image-form" action="api/upload_book_image.php" method="post" enctype="multipart/form-data">
        <input type="hidden" name="book_id" value="<?= htmlspecialchars($bookId, ENT_QUOTES) ?>">

        <label class="book-image-wrapper">
            <img id="book-image" alt="Couverture du livre" />
            <button class="book-image-edit">Modifier la photo</button>
            <input type="file"
                   name="image"
                   accept="image/*"
                   class="book-image-input"
                   onchange="this.form.submit()">
        </label>
    </form>
</div>

    <div class="form-update">
        <form>
            <label for="titre">Titre</label>
            <input type="text" id="titre" name="titre"><br><br>

            <label for="auteur">Auteur</label>
            <input type="text" id="auteur" name="auteur"><br><br>

            <label for="description">Commentaire</label>
            <textarea id="description" name="description" rows="4"></textarea><br><br>

            <label for="dispo">DisponibilitÃ©</label>
            <select name="dispo" id="dispo">
                <option value="1">Disponible</option>
                <option value="0">Indisponible</option>
            </select>

            <button type="button" id="submit-update">Valider</button>
        </form>
    </div>
</div>


<script type="module">
 import { updateBook, getBookById } from './services/profile.js';

    const bookId = <?= json_encode($bookId) ?>;

    document.addEventListener("DOMContentLoaded", () => {
        const titreInput = document.getElementById('titre');
        const auteurInput = document.getElementById('auteur');
        const descriptionInput = document.getElementById('description');
        const dispoSelect = document.getElementById('dispo');
        const imageEl = document.getElementById('book-image');

        let currentImage = '';

        // Charger les infos du livre Ã  partir de l'API
        getBookById(bookId)
            .then((book) => {
                titreInput.value = book.titre || '';
                auteurInput.value = book.auteur || '';
                descriptionInput.value = book.description || '';
                dispoSelect.value = String(book.dispo ?? '1');

                currentImage = book.image || '';
                if (currentImage) {
                    imageEl.src = currentImage;
                    imageEl.alt = book.titre || '';
                } else {
                    imageEl.style.display = 'none';
                }
            })
            .catch((error) => {
                console.error("Erreur lors du chargement du livre", error);
                alert("Impossible de charger ce livre.");
                window.location.href = "account.php";
            });

        // Click sur "Valider"
        document.getElementById("submit-update").addEventListener('click', () => {
            const titre = titreInput.value.trim();
            const auteur = auteurInput.value.trim();
            const description = descriptionInput.value.trim();
            const dispo = dispoSelect.value;

            if (!titre || !auteur) {
                alert("Titre et auteur sont obligatoires.");
                return;
            }

            updateBook(bookId, titre, auteur, currentImage, description, dispo)
                .then((data) => {
                    console.log("Livre Ã©ditÃ© avec succÃ¨s", data);
                    window.location.href = "account.php";
                })
                .catch((error) => {
                    console.error("Erreur lors de la modification", error);
                    alert("Erreur lors de la modification du livre.");
                });
        });
    });
</script>
<?php include './templates/footer.php'; ?>

===============================================
File: user.php
===============================================

<?php 
    $selectedMenu = 'home';
?>

<?php include 'templates/header.php'; ?>

<div class="user-profile-page">

    <div class="user-profile-layout">

        <div class="user-profile-card">

            <form class="user-profile-avatar-form" action="api/upload_avatar.php" method="post" enctype="multipart/form-data">
                <label class="user-profile-avatar-wrapper">
                    <img src="assets/default-avatar.png" alt="Avatar" class="user-profile-avatar">
                </label>
            </form>

            <hr class="user-profile-separator"/>

            <div>
                <span class="user-profile-username"></span>
                <span class="user-profile-created">Membre depuis</span>
    
                <span class="user-profile-library-label">BibliothÃ¨que</span>
                <span class="user-profile-books-count"></span>
    
                <button class="user-profile-message-btn">Ã‰crire un message</button>
            </div>

        </div>

        <div class="user-books-container">
            <table class="user-books-table">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Titre</th>
                        <th>Auteur</th>
                        <th>Description</th>
                    </tr>
                </thead>

                <tbody id="user-books-list"></tbody>

            </table>
        </div>

    </div>
</div>


<script type="module">
import { getUserBooks, getUserById } from './services/profile.js';

document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const userId = params.get("user_id");

  // RÃ©fÃ©rences DOM avec les NOUVELLES CLASSES
  const avatarImg   = document.querySelector(".user-profile-avatar");
  const usernameEl  = document.querySelector(".user-profile-username");
  const createdEl   = document.querySelector(".user-profile-created");
  const booksCount  = document.querySelector(".user-profile-books-count");
  const tbody       = document.getElementById("user-books-list");

  if (!userId) {
    window.location.href = "books.php";
    return;
  }

  // Profil
  getUserById(userId)
    .then((user) => {
      avatarImg.src = user.image || "assets/default-avatar.png";
      usernameEl.textContent = user.username || "";

      if (user.created_at) {
        const date = new Date(user.created_at);
        createdEl.textContent = "Membre depuis " + date.toLocaleDateString("fr-FR", {
          year: "numeric",
          month: "long",
        });
      }
    });

  // Livres
  getUserBooks(userId)
    .then((books) => {
      booksCount.textContent = `${books.length} livres`;
      tbody.innerHTML = "";

      books.forEach((book, i) => {
        const rowClass = i % 2 === 0 ? "user-book-row even" : "user-book-row odd";

        const tr = document.createElement("tr");
        tr.className = rowClass;

        tr.innerHTML = `
          <td><img src="${book.image}" class="user-books-photo"></td>
          <td>${book.titre}</td>
          <td>${book.auteur}</td>
          <td class="user-books-desc">${book.description}</td>
        `;

        tbody.appendChild(tr);
      });

    });
});
</script>

<?php include 'templates/footer.php'; ?>


===============================================
File: api/books.php
===============================================

<?php 

require_once '../config/database.php';
require_once '../managers/livreManager.php';

$booksManager = new LivreManager($db);

// Si POST mais pas connectÃ© â†’ refus
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_SESSION['currentUserId'])) {
    http_response_code(401);
    echo json_encode(['erreur' => 'Utilisateur non authentifiÃ©']);
    return;
}

//Upload d'une nouvelle image
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['image']) && isset($_POST['book_id'])) {

    $bookId = (int) $_POST['book_id'];
    $file   = $_FILES['image'];

    if ($file['error'] !== UPLOAD_ERR_OK) {
        header('Location: ../updateBook.php?id=' . $bookId);
        return;
    }

    // Dossier de destination (par ex. assets/uploads/books/)
    $uploadDir = '../assets/uploads/books/';
    if (!is_dir($uploadDir)) {
        mkdir($uploadDir, 0775, true);
    }

    $extension = pathinfo($file['name'], PATHINFO_EXTENSION);
    $extension = strtolower($extension) ?: 'jpg';

    $filename   = 'book_' . $bookId . '_' . time() . '.' . $extension;
    $destPath   = $uploadDir . $filename;
    $publicPath = 'assets/uploads/books/' . $filename; // stockÃ© en BDD

    if (!move_uploaded_file($file['tmp_name'], $destPath)) {
        header('Location: ../updateBook.php?id=' . $bookId);
        return;
    }

    // Mise Ã  jour de l'image en BDD
    $booksManager->updateBookImage($bookId, $publicPath);

    // Retour sur la page d'Ã©dition du livre
    header('Location: ../updateBook.php?id=' . $bookId);
    return;
}

// crÃ©ation d'un livre
if ($_SERVER['REQUEST_METHOD'] === 'POST'
    && isset($_POST['titre'])
    && isset($_POST['auteur'])
    && isset($_POST['description'])
    && !isset($_POST['id'])) {

    $titre = $_POST['titre'];
    $auteur = $_POST['auteur'];
    $description = $_POST['description'];
    $dispo = isset($_POST['dispo']) ? $_POST['dispo'] : 1;
    $currentUserId = $_SESSION['currentUserId'];

    $imagePath = ''; // par dÃ©faut : pas d'image

    // Si un fichier "image" a Ã©tÃ© envoyÃ©, on tente l'upload
    if (!empty($_FILES['image']) && $_FILES['image']['error'] === UPLOAD_ERR_OK) {
        $file = $_FILES['image'];

        $uploadDir = '../assets/';
        if (!is_dir($uploadDir)) {
            mkdir($uploadDir, 0775, true);
        }

        $extension = pathinfo($file['name'], PATHINFO_EXTENSION);
        $extension = strtolower($extension ?: 'jpg');

        $filename   = 'book_' . time() . '_' . bin2hex(random_bytes(4)) . '.' . $extension;
        $destPath   = $uploadDir . $filename;
        $publicPath = 'assets/' . $filename;

        if (move_uploaded_file($file['tmp_name'], $destPath)) {
            $imagePath = $publicPath;
        }
    }

    $livre = new Livre();
    $livre->setTitre($titre);
    $livre->setAuteur($auteur);
    $livre->setImage($imagePath);
    $livre->setDescription($description);
    $livre->setDispo($dispo);
    $livre->setUserId($currentUserId);

    $booksManager->createBook($livre);
    echo json_encode(['succÃ¨s' => 'Livre crÃ©e']);
    return;

   //update d'un livre
} else if (isset($_POST['id']) && isset($_POST['titre']) && isset($_POST['auteur']) && isset($_POST['image']) && isset($_POST['description']) && isset($_POST['dispo'])) {
    $id = $_POST['id'];
    $titre = $_POST['titre'];
    $auteur = $_POST['auteur'];
    $image = $_POST['image'];
    $description = $_POST['description'];
    $dispo = $_POST['dispo'];

    $currentUserId = $_SESSION['currentUserId'];

    $livre = new Livre();
    $livre->setId($id);
    $livre->setTitre($titre);
    $livre->setAuteur($auteur);
    $livre->setImage($image);
    $livre->setDescription($description);
    $livre->setDispo($dispo);
    $livre->setUserId($currentUserId);

    $booksManager->updateBook($livre);

    echo json_encode(['succÃ¨s' => 'Livre mis Ã  jour']);
    return;

   //suppression d'un livre
} else if (isset($_POST['id'])) {

    $currentUserId = $_SESSION['currentUserId'];
    $id = $_POST['id'];

    $booksManager->deleteBook($id);
    echo json_encode(['succÃ¨s' => 'Livre supprimÃ©']);
    return;

    //rÃ©cup livre par user id
} else if (isset($_GET['user_id'])) {
    $books = $booksManager->getBooksByUserId($_GET['user_id']);
    echo json_encode($books);
    return;

    //rÃ©cupÃ©rer livre par id
} else if (isset($_GET['id'])) {
    $book = $booksManager->getBookById($_GET['id']);
    echo json_encode($book);
    return;

    //rÃ©cupÃ©rer les livres du user connectÃ©
} else {
    $books = $booksManager->findAllBooks();
    echo json_encode($books);
    return;
}
?>


===============================================
File: api/commentaire.php
===============================================

<?php
require_once '../config/database.php';
require_once '../managers/commentaireManager.php';

$commentaireManager = new CommentaireManager($db);

if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_SESSION['currentUserId'])) {
    http_response_code(401);
    echo json_encode(['erreur' => 'Utilisateur non authentifiÃ©']);
    return;
} 
//CrÃ©ation d'un commentaire pour un livre
else if(isset($_POST['contenu']) && isset($_POST['created_at']) && isset($_POST['livre_id'])) {
    $contenu = $_POST['contenu'];
    $created_at = $_POST['created_at'];
    $user_id = $_SESSION['currentUserId'];
    $livre_id = $_POST['livre_id'];

    $commentaire = new Commentaire();
    $commentaire->setContenu($contenu);
    $commentaire->setCreatedAt($created_at);
    $commentaire->setUserId($user_id);
    $commentaire->setLivreId($livre_id);
    //Si les champs ne sont pas tous remplis
} else if(isset($_POST['contenu']) || isset($_POST['created_at']) || isset($_POST['livre_id'])) {
    //Erreur : remplir tous les champs est obligatoire
    http_response_code(400);
    echo json_encode(['error' => 'Tous les champs sont requis pour crÃ©er un commentaire']);
    return;
    //RÃ©cupÃ©ration des commentaires par livre
} else if(isset($_GET['livre_id'])) { 
    $comment = $commentaireManager->getCommentsByBookId($_GET['livre_id']);
    //Si les commentaires existent on les renvoie
    if($comment) {
        echo json_encode($comment);
        return;
        //Si ils existent pas, ils ne sont pas trouvÃ©s donc 404
    } else { 
        http_response_code(404);
        echo json_encode(['error' => 'Commentaires non trouvÃ©es']);
        return;
    }
} else if (isset($_POST['delete_id'])) {
    //Suppression d'un commentaire pour un livre donnÃ© seulement si c'est le user qui l'a crÃ©e
    $commentaireManager->deleteCommentBook($_POST['delete_id']);
}

?>

===============================================
File: api/conversations.php
===============================================

<?php
require_once '../config/database.php';
require_once '../managers/conversationManager.php';
require_once '../managers/messageManager.php';
require_once '../models/messageModel.php';

header('Content-Type: application/json; charset=utf-8');

$conversationManager = new ConversationManager($db);
$messageManager      = new MessageManager($db);


//Helper : vÃ©rifier que l'user est connectÃ©
function requireAuth(): int {
    if (!isset($_SESSION['currentUserId'])) {
        http_response_code(401);
        echo json_encode(['error' => 'Non connectÃ©']);
        exit;
    }
    return (int) $_SESSION['currentUserId'];
}

 //Sans paramÃ¨tre : liste des conversations du user connectÃ©
 //Avec ?conversation_id=X : liste des messages de cette conversation
if ($_SERVER['REQUEST_METHOD'] === 'GET') {

    $currentUserId = requireAuth();

    if (isset($_GET['conversation_id']) && isset($_GET['participants'])) {
    $conversationId = (int) $_GET['conversation_id'];

    if ($conversationId <= 0) {
        http_response_code(400);
        echo json_encode(['error' => 'conversation_id invalide']);
        exit;
    }

    // VÃ©rifier que le user connectÃ© participe Ã  la conversation
    $participantsIds = $conversationManager->getParticipants($conversationId);
    if (!in_array($currentUserId, $participantsIds, true)) {
        http_response_code(403);
        echo json_encode(['error' => 'AccÃ¨s interdit Ã  cette conversation']);
        exit;
    }

    // On renvoie id + username + image
    $infos = $conversationManager->getParticipantInfos($conversationId);
    echo json_encode($infos);
    exit;
}

    //GET /api/conversations.php?conversation_id=123
    if (isset($_GET['conversation_id'])) {
        $conversationId = (int) $_GET['conversation_id'];

        if ($conversationId <= 0) {
            http_response_code(400);
            echo json_encode(['error' => 'conversation_id invalide']);
            exit;
        }

        $participants = $conversationManager->getParticipants($conversationId);

        if (!in_array($currentUserId, $participants, true)) {
            http_response_code(403);
            echo json_encode([
                'error' => 'Vous ne participez pas Ã  cette conversation'
            ]);
            exit;
        }

        $messages = $messageManager->getMessagesByConversationId($conversationId);
        echo json_encode($messages);
        exit;
    }

    // GET GET /api/conversations.php
    // Liste des conversations du user connectÃ© (avec last_message_at)
    $conversations = $conversationManager->getConversationsSummaryByUserId($currentUserId);
    echo json_encode($conversations);
    exit;
}


    //Avec user_id : crÃ©er une conversation entre moi et ce user
    //Avec conversation_id + content : crÃ©er un message dans la conversation
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {

        $currentUserId = requireAuth();

        // On rÃ©cupÃ¨re les donnÃ©es POST de faÃ§on safe
        $userId         = isset($_POST['user_id']) ? (int) $_POST['user_id'] : 0;
        $conversationId = isset($_POST['conversation_id']) ? (int) $_POST['conversation_id'] : 0;
        $content        = isset($_POST['content']) ? trim($_POST['content']) : '';

    //CrÃ©ation d'une nouvelle conversation
    //POST /api/conversations.php avec user_id=X
    if ($userId > 0 && $conversationId === 0 && $content === '') {

        if ($userId === $currentUserId) {
            http_response_code(400);
            echo json_encode(['error' => 'Impossible de crÃ©er une conversation avec soi-mÃªme']);
            exit;
        }

        $existingConvId = $conversationManager->findConversationBetweenUsers($currentUserId, $userId);

        if ($existingConvId !== null) {
            // On ne recrÃ©e pas, on renvoie juste l'ID existant
            http_response_code(200);
            echo json_encode([
                'success'         => true,
                'conversation_id' => $existingConvId,
                'existing'        => true
            ]);
        exit;
    }

        // On crÃ©e une conversation vide
        $newConversationId = $conversationManager->createConversation();

        // On ajoute le user connectÃ© + l'autre user comme participants
        $conversationManager->addUserToConversation($newConversationId, $currentUserId);
        $conversationManager->addUserToConversation($newConversationId, $userId);

        http_response_code(201);
        echo json_encode([
            'success'         => true,
            'conversation_id' => $newConversationId
        ]);
        exit;
    }

    // CrÃ©ation d'un message dans une conversation
    // POST /api/conversations.php avec conversation_id=X & content=...
    if ($conversationId > 0 && $content !== '') {

        // TODO (optionnel) : vÃ©rifier que $currentUserId est bien participant de cette conversation

        $message = new Message();
        $message->setSenderId($currentUserId);
        $message->setConversationId($conversationId);
        $message->setContent($content);

        $messageManager->createMessage($message);

        http_response_code(201);
        echo json_encode(['success' => true, 'message' => json_encode($message)]);
        exit;
    }

    //Sinon : requÃªte POST invalide
    http_response_code(400);
    echo json_encode(['error' => 'ParamÃ¨tres POST invalides']);
    exit;
}

// MÃ©thode HTTP non gÃ©rÃ©e
http_response_code(405);
echo json_encode(['error' => 'MÃ©thode non autorisÃ©e']);
exit;


===============================================
File: api/login.php
===============================================

<?php
require_once '../config/database.php';
require_once '../managers/userManager.php';

$userManager = new UserManager($db);

//Connexion d'un user l'email et le password doivent Ãªtre fournis
if(isset($_POST['email']) && isset($_POST['password'])) {
    $email = $_POST['email'];
    $password = $_POST['password'];

    $user = $userManager->getUserByEmail($email);

    //Si le password correspond Ã  celui qui est en base de donnÃ©es
    if($user && password_verify($password, $user->getPassword())) {
        //Connexion rÃ©ussie
        echo json_encode($user);
        $_SESSION['currentUserId'] = $user->getId();
        return;
    } else {
        //Si le password ne correspond pas : Ã‰chec de la connexion
        http_response_code(401);
        echo json_encode(['error' => 'Identifiant ou mot de passe incorrect']);
        return;
    }
    //Si on est en GET et qu'un user est connectÃ©, on le renvoie
} else if(isset($_SESSION['currentUserId'])) {
    $user = $userManager->getUserById($_SESSION['currentUserId']);

    if($user) {
        echo json_encode($user);
        return;
    } else {
        http_response_code(500);
        echo json_encode(['error' => 'Erreur lors de la rÃ©cupÃ©ration du user connectÃ©']);
        return;
    }
    //Si les champs username et password ne sont pas fournis
} else {
    http_response_code(400);
    echo json_encode(['error' => 'Identifiants et mot de passe requis' . json_encode($_POST) . json_encode($_SESSION)]);
    return;
}

?>

===============================================
File: api/message.php
===============================================

<?php
require_once '../config/database.php';
require_once '../managers/messageManager.php';

$messageManager = new MessageManager($db);

//RÃ©cupÃ©ration la conversation avec un user
if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['user_id'])) {

    if (!isset($_SESSION['currentUserId'])) {
        http_response_code(401);
        echo json_encode(['error' => 'Non connectÃ©']);
        return;
    }

    $currentUserId = $_SESSION['currentUserId'];
    $otherUserId   = (int) $_GET['user_id'];

    $messages = $messageManager->getConversation($currentUserId, $otherUserId);

    echo json_encode($messages);
    return;
    //RÃ©cupÃ©ration de tous MES messages
} else if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['mine'])) {

    if (!isset($_SESSION['currentUserId'])) {
        http_response_code(401);
        echo json_encode(['error' => 'Non connectÃ©']);
        return;
    }

    $currentUserId = $_SESSION['currentUserId'];

    $messages = $messageManager->getMessagesByUserId($currentUserId);

    echo json_encode($messages);
    return;
    //Envoyer un message
} else if ($_SERVER['REQUEST_METHOD'] === 'POST') {

    if (!isset($_SESSION['currentUserId'])) {
        http_response_code(401);
        echo json_encode(['error' => 'Non connectÃ©']);
        return;
    }

    $senderId   = $_SESSION['currentUserId'];
    $receiverId = (int) $_POST['receiver_id'];
    $bookId     = isset($_POST['book_id']) ? (int) $_POST['book_id'] : null;
    $content    = trim($_POST['content']);

    if ($content === '') {
        http_response_code(400);
        echo json_encode(['error' => 'Message vide']);
        return;
    }

    $message = new Message();
    $message->setSenderId($senderId);
    $message->setReceiverId($receiverId);
    $message->setBookId($bookId);
    $message->setContent($content);

    $messageManager->createMessage($message);

    echo json_encode(['success' => 'Message envoyÃ©']);
    return;
}
?>

===============================================
File: api/profile.php
===============================================

<?php
require_once '../config/database.php';
require_once '../managers/userManager.php';
require_once '../managers/livreManager.php';

if (!isset($_SESSION['currentUserId'])) {
    http_response_code(401);
    echo json_encode(['error' => 'Utilisateur non authentifiÃ©']);
    exit;
}

$userManager = new UserManager($db);
$livreManager = new LivreManager($db);

$user = $userManager->getUserById($_SESSION['currentUserId']);

if (!$user) {
    http_response_code(404);
    echo json_encode(['error' => 'Utilisateur non trouvÃ©']);
    exit;
}

// base : on prend ce que renvoie jsonSerialize()
$data = $user->jsonSerialize();

// on ajoute le nombre de livres
$data['library'] = $livreManager->countBooksByUserId($user->getId());

echo json_encode($data);


===============================================
File: api/upload_avatar.php
===============================================

<?php
require_once '../config/database.php';
require_once '../managers/userManager.php';

if (!isset($_SESSION['currentUserId'])) {
    header('Location: ../login.php');
    exit;
}

$userId = $_SESSION['currentUserId'];

//VÃ©rif fichier
if (!isset($_FILES['avatar']) || $_FILES['avatar']['error'] !== UPLOAD_ERR_OK) {
    header('Location: ../account.php');
    exit;
}

$file = $_FILES['avatar'];

//Types autorisÃ©s
$allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
if (!in_array($file['type'], $allowedTypes, true)) {
    header('Location: ../account.php');
    exit;
}

//Taille max 2 Mo
if ($file['size'] > 2 * 1024 * 1024) {
    header('Location: ../account.php');
    exit;
}

//Dossier de destination = assets/
$uploadDir = '../assets/';

// On s'assure qu'il existe
if (!is_dir($uploadDir)) {
    mkdir($uploadDir, 0775, true);
}

//Nom unique du fichier
$extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION) ?: 'jpg');
$filename = 'avatar_' . $userId . '_' . time() . '.' . $extension;

//Chemins
$destinationPath = $uploadDir . $filename;      // Sur le disque
$imagePathForDb  = 'assets/' . $filename;       // En BDD et visible via <img>

//DÃ©placement du fichier
if (!move_uploaded_file($file['tmp_name'], $destinationPath)) {
    header('Location: ../account.php');
    exit;
}

//Mise Ã  jour du user
$userManager = new UserManager($db);
$userManager->updateUserImage($userId, $imagePathForDb);

//Retour Ã  la page profil
header('Location: ../account.php');
exit;


===============================================
File: api/user.php
===============================================

<?php 
require_once '../config/database.php';
require_once '../managers/userManager.php';

$userManager = new UserManager($db);

//CrÃ©ation d'un user (s'il n'est pas connectÃ©)
if (!isset($_SESSION['currentUserId'])
    && isset($_POST['username']) 
    && isset($_POST['email']) 
    && isset($_POST['password'])) {

    $username = $_POST['username'];
    $email    = $_POST['email'];
    $password = $_POST['password'];

    // VÃ©rification si le username Ã©crit existe dÃ©jÃ  ?
    $isExistingUser = $userManager->getUserByUsername($username);
    if($isExistingUser) {
        http_response_code(409);
        echo json_encode(['erreur' => 'Nom dutilisateur dÃ©jÃ  pris']);
        return;
    } else {
        // On crÃ©e le nouveau user
        $user = new User();
        $user->setUsername($username);
        $user->setEmail($email);
        $user->setPassword($password);

        $userManager->createUser($user);

        // On rÃ©cupÃ¨re le user nouvellement crÃ©Ã© pour rÃ©cupÃ©rer son id
        $created = $userManager->getUserByEmail($email);
        if ($created) {
            $_SESSION['currentUserId'] = $created->getId();
        }

        echo json_encode(['succÃ¨s' => 'Utilisateur crÃ©e avec succÃ¨s']);
        return;
    }

    //Update d'un user existant
} else if (isset($_SESSION['currentUserId']) && isset($_POST['username'])) {

    // vÃ©rification authentification
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_SESSION['currentUserId'])) {
        http_response_code(401);
        echo json_encode(['erreur' => 'Utilisateur non authentifiÃ©']);
        return;
    }

    $userId   = $_SESSION['currentUserId'];
    $username = $_POST['username'];
    $email    = $_POST['email'] ?? null;
    $password = $_POST['password'] ?? null;

    $user = $userManager->getUserById($userId);

    if (!$user) {
        http_response_code(404);
        echo json_encode(['erreur' => 'Utilisateur non trouvÃ©']);
        return;
    }

    $user->setUsername($username);

    if ($email !== null) {
        $user->setEmail($email);
    }

    if ($password !== null && trim($password) !== "") {
        $user->setPassword($password);
    } else {
        $user->setPassword(null);
    }

    $userManager->updateUser($user);
    echo json_encode(['succÃ¨s' => 'Profil mis Ã  jour']);
    return;

    // RÃ©cupÃ©rer un user par id
} else if (isset($_GET['id'])) {
     $user = $userManager->getUserById((int) $_GET['id']);

    if ($user) {
        $response = [
            'id'         => $user->getId(),
            'username'   => $user->getUsername(),
            'image'      => $user->getImage(),
            'created_at' => $user->getCreatedAt(),
        ];

        echo json_encode($response);
        return;
    } else {
        http_response_code(404);
        echo json_encode(['error' => 'Utilisateur non trouvÃ©']);
        return;
    }

    // Sinon : renvoyer tous les users
} else {
    $users = $userManager->findAll();
    echo json_encode($users);
    return;
}

?>


===============================================
File: config/database.php
===============================================

<?php

session_start();

//Connexion Ã  la base de donnÃ©es
try {
    $db = new PDO('mysql:host=localhost;dbname=tomtroc;charset=utf8', 'root', '', [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION],);
} catch (Exception $e) {
    die('Erreur : ' . $e->getMessage());
}
?>

===============================================
File: managers/conversationManager.php
===============================================

<?php
require_once '../models/conversationModel.php';

class ConversationManager
{
    private PDO $db;

    public function __construct(PDO $db)
    {
        $this->db = $db;
    }


    //CrÃ©e une conversation vide.
    //Retourne l'ID de la nouvelle conversation.
    public function createConversation(): int
    {
        $createConvRequest = "INSERT INTO conversation () VALUES ()";
        $createConvStmt = $this->db->prepare($createConvRequest);
        $createConvStmt->execute();

        return (int) $this->db->lastInsertId();
    }

    //Ajoute un utilisateur comme participant Ã  une conversation
    public function addUserToConversation(int $conversationId, int $userId): void
    {
        $addUserToConvRequest = "INSERT INTO conversation_user (conversation_id, user_id)
                VALUES (:conversation_id, :user_id)";

        $addUserToConvStmt = $this->db->prepare($addUserToConvRequest);
        $addUserToConvStmt->execute([
            'conversation_id' => $conversationId,
            'user_id'         => $userId
        ]);
    }

    //RÃ©cupÃ¨re toutes les conversations oÃ¹ participe un user
    public function getConversationsByUserId(int $userId): array
    {
        $getConvByUserIdRequest = "SELECT c.*
                FROM conversation c
                INNER JOIN conversation_user cu ON cu.conversation_id = c.id
                WHERE cu.user_id = :user_id
                ORDER BY c.created_at DESC";

        $getConvByUserIdStmt = $this->db->prepare($getConvByUserIdRequest);
        $getConvByUserIdStmt->setFetchMode(PDO::FETCH_CLASS, 'Conversation');
        $getConvByUserIdStmt->execute(['user_id' => $userId]);

        return $getConvByUserIdStmt->fetchAll();
    }

    //RÃ©cupÃ¨re la liste des participants d'une conversation
    public function getParticipants(int $conversationId): array
    {
        $getParticipantRequest = "SELECT user_id
                FROM conversation_user
                WHERE conversation_id = :conversation_id";

        $getParticipantStmt = $this->db->prepare($getParticipantRequest);
        $getParticipantStmt->execute(['conversation_id' => $conversationId]);

        return $getParticipantStmt->fetchAll(PDO::FETCH_COLUMN);
    }

    public function getParticipantNames(int $conversationId): array
    {
        $getParticipantNamesRequest = "SELECT u.username
                FROM conversation_user cu
                INNER JOIN user u ON u.id = cu.user_id
                WHERE cu.conversation_id = :conversation_id
                ORDER BY u.username ASC";

        $getParticipantNamesStmt = $this->db->prepare($getParticipantNamesRequest);
        $getParticipantNamesStmt->execute([
            'conversation_id' => $conversationId,
        ]);

        // Retourne simplement un tableau de strings (usernames)
        return $getParticipantNamesStmt->fetchAll(PDO::FETCH_COLUMN);
    }


    //VÃ©rifie si une conversation existe
    public function conversationExists(int $conversationId): bool
    {
        $conversationExistsRequest = "SELECT id FROM conversation WHERE id = :id";
        $conversationExistsStmt = $this->db->prepare($conversationExistsRequest);
        $conversationExistsStmt->execute(['id' => $conversationId]);

        return (bool) $conversationExistsStmt->fetchColumn();
    }

    //RÃ©cupÃ¨re le last message
    public function getConversationsSummaryByUserId(int $userId): array
    {
        $getConvSumByUserIdRequest = " SELECT c.id, c.created_at,
                -- date du dernier message
                (
                    SELECT m2.created_at
                    FROM message m2
                    WHERE m2.conversation_id = c.id
                    ORDER BY m2.created_at DESC
                    LIMIT 1
                ) AS last_message_at,
                
                -- contenu du dernier message
                (
                    SELECT m3.content
                    FROM message m3
                    WHERE m3.conversation_id = c.id
                    ORDER BY m3.created_at DESC
                    LIMIT 1
                ) AS last_message_content
            FROM conversation c
            INNER JOIN conversation_user cu 
                ON cu.conversation_id = c.id
            WHERE cu.user_id = :user_id
            ORDER BY 
                COALESCE(
                    (
                        SELECT m4.created_at
                        FROM message m4
                        WHERE m4.conversation_id = c.id
                        ORDER BY m4.created_at DESC
                        LIMIT 1
                    ),
                    c.created_at
                ) DESC
        ";

        $getConvSumByUserIdStmt = $this->db->prepare($getConvSumByUserIdRequest);
        $getConvSumByUserIdStmt->execute(['user_id' => $userId]);

        return $getConvSumByUserIdStmt->fetchAll(PDO::FETCH_ASSOC);
    }


    //RÃ©cupÃ¨re les conversations entre deux users
    public function findConversationBetweenUsers(int $user1Id, int $user2Id): ?int
    {
        $findConvBetweenUserRequest = " SELECT c.id FROM conversation c INNER JOIN conversation_user cu1 ON cu1.conversation_id = c.id AND cu1.user_id = :u1 INNER JOIN conversation_user cu2 ON cu2.conversation_id = c.id AND cu2.user_id = :u2 LIMIT 1";

        $findConvBetweenUserStmt = $this->db->prepare($findConvBetweenUserRequest);
        $findConvBetweenUserStmt->execute([
            'u1' => $user1Id,
            'u2' => $user2Id,
        ]);

        $convId = $findConvBetweenUserStmt->fetchColumn();

        return $convId !== false ? (int) $convId : null;
    }

    public function getParticipantInfos(int $conversationId): array 
    {
        $getParticipantsInfoRequest = "
            SELECT u.id, u.username, u.image
            FROM conversation_user cu
            JOIN user u ON u.id = cu.user_id
            WHERE cu.conversation_id = :conversation_id
        ";

        $getParticipantsInfoStmt = $this->db->prepare($getParticipantsInfoRequest);
        $getParticipantsInfoStmt->execute(['conversation_id' => $conversationId]);

        return $getParticipantsInfoStmt->fetchAll(PDO::FETCH_ASSOC);
    }


}
?>


===============================================
File: managers/livreManager.php
===============================================

<?php
require_once '../models/livreModel.php';

class LivreManager {
    private $db;
    public function __construct($db) {
        $this->db = $db;
    }

    //RÃ©cupÃ©rer tous les livres un nombre par user
    public function countBooksByUserId(int $userId): int {

    $countBooksByUserIdRequest = 'SELECT COUNT(*) FROM livre WHERE user_id = :user_id';

    $countBooksByUserIdStmt = $this->db->prepare($countBooksByUserIdRequest);
    $countBooksByUserIdStmt->execute([
        'user_id' => $userId,
    ]);

    return (int) $countBooksByUserIdStmt->fetchColumn();
}


    //RÃ©cupÃ©rer des livres par userId
    public function getBooksByUserId(int $userId) {

        $getBooksRequest = 'SELECT * FROM livre WHERE user_id = :user_id';

        $getBooksStmt = $this->db->prepare($getBooksRequest);
        $getBooksStmt->setFetchMode(PDO::FETCH_CLASS, 'Livre');
        $getBooksStmt->execute( [
            'user_id' => $userId
        ] );

        return $getBooksStmt->fetchAll();

    }

    //RÃ©cupÃ©rer des livres par userId
    public function getBookById(int $id) {

        $getBooksRequest = '
            SELECT
                l.id        AS id,
                l.titre     AS titre,
                l.auteur    AS auteur,
                l.image     AS image,
                l.description AS description,
                l.dispo     AS dispo,
                l.user_id   AS user_id,
                u.username  AS user_name
            FROM livre l
            JOIN user u ON l.user_id = u.id
            WHERE l.id = :id
        ';

        $getBooksStmt = $this->db->prepare($getBooksRequest);
        $getBooksStmt->setFetchMode(PDO::FETCH_CLASS, 'Livre');
        $getBooksStmt->execute( [
            'id' => $id
        ] );

        return $getBooksStmt->fetch();

    }

    // RÃ©cupÃ©rer tous les livres
    public function findAllBooks() {

        $findAllBooksRequest = '
            SELECT
                l.id        AS id,
                l.titre     AS titre,
                l.auteur    AS auteur,
                l.image     AS image,
                l.description AS description,
                l.dispo     AS dispo,
                l.user_id   AS user_id,
                u.username  AS user_name
            FROM livre l
            JOIN user u ON l.user_id = u.id
            WHERE l.dispo = 1
        ';

        $findAllBooksStmt = $this->db->prepare($findAllBooksRequest);
        $findAllBooksStmt->setFetchMode(PDO::FETCH_CLASS, 'Livre');
        $findAllBooksStmt->execute();

        return $findAllBooksStmt->fetchAll();
    }


    //CrÃ©er un livre : passer le currentUserId en paramÃ¨tre (souvent venant de $_SESSION['user_id']).
    public function createBook(Livre $livre) {

        $createBookRequest = 'INSERT INTO livre (titre, auteur, image, description, dispo, user_id) VALUES (:titre, :auteur, :image, :description, :dispo, :user_id)';

        $createBookStmt = $this->db->prepare($createBookRequest);
        $createBookStmt->execute ([
            'titre' => $livre->getTitre(),
            'auteur' => $livre->getAuteur(),
            'image' => $livre->getImage(),
            'description' => $livre->getDescription(),
            'dispo' => $livre->getDispo(),
            'user_id' => $_SESSION['currentUserId']
        ]);
    }


    //Supprimer un livre : passer le currentUserId en paramÃ¨tre (venant de $_SESSION['user_id']).
    public function deleteBook(int $id) {

        $deleteBookRequest = 'DELETE FROM livre WHERE id = :id AND user_id = :user_id';

        $deleteBookStmt = $this->db->prepare($deleteBookRequest);
        $deleteBookStmt->execute ([
            'id' => $id,
            'user_id' => $_SESSION['currentUserId']
        ]);
    }

    //Mettre Ã  jour un livre
    public function updateBook(Livre $livre) {

        $updateBookRequest = 'UPDATE livre SET titre = :titre, auteur = :auteur, image = :image, description = :description, dispo = :dispo WHERE id = :id AND user_id = :user_id';

        $updateBookStmt = $this->db->prepare($updateBookRequest);
        $updateBookStmt->execute ([
            'titre' => $livre->getTitre(),
            'auteur' => $livre->getAuteur(),
            'image' => $livre->getImage(),
            'description' => $livre->getDescription(),
            'dispo' => $livre->getDispo(),
            'id' => $livre->getId(),
            'user_id' => $_SESSION['currentUserId']
        ]);
    }

    // Met Ã  jour uniquement l'image d'un livre
    public function updateBookImage(int $bookId, string $imagePath): void
    {
        $updateBookImageRequest = 'UPDATE livre 
                SET image = :image 
                WHERE id = :id AND user_id = :user_id';

        $supdateBookImageStmt = $this->db->prepare($updateBookImageRequest);
        $supdateBookImageStmt->execute([
            'image'   => $imagePath,
            'id'      => $bookId,
            'user_id' => $_SESSION['currentUserId'],
        ]);
    }
}
?>

===============================================
File: managers/messageManager.php
===============================================

<?php
require_once '../models/messageModel.php';

class MessageManager
{
    private PDO $db;

    public function __construct(PDO $db)
    {
        $this->db = $db;
    }

    //Envoie un message dans une conversation
    public function createMessage(Message $message): void
    {
        $createMsgRequest = "INSERT INTO message (conversation_id, user_id, content)
                VALUES (:conversation_id, :user_id, :content)";

        $createMsgStmt = $this->db->prepare($createMsgRequest);
        $createMsgStmt->execute([
            'conversation_id' => $message->getConversationId(),
            'user_id'         => $message->getSenderId(),
            'content'         => $message->getContent(),
        ]);
    }

    //RÃ©cupÃ¨re tous les messages d'une conversation
    public function getMessagesByConversationId(int $conversationId): array
    {
        $getMessagesByConvIdRequest = "SELECT *, user_id as sender_id
                FROM message
                WHERE conversation_id = :conversation_id
                ORDER BY created_at ASC";

        $getMessagesByConvIdStmt = $this->db->prepare($getMessagesByConvIdRequest);
        $getMessagesByConvIdStmt->setFetchMode(PDO::FETCH_CLASS, 'Message');
        $getMessagesByConvIdStmt->execute(['conversation_id' => $conversationId]);

        return $getMessagesByConvIdStmt->fetchAll();
    }

    //Marquer un message comme lu
    public function markAsRead(int $messageId): void
    {
        $markAsReadRequest = "UPDATE message
                SET read_at = NOW()
                WHERE id = :id";

        $markAsReadStmt = $this->db->prepare($markAsReadRequest);
        $markAsReadStmt->execute(['id' => $messageId]);
    }
}
?>


===============================================
File: managers/userManager.php
===============================================

<?php
require_once '../models/userModel.php';

class UserManager {
    private $db;
    public function __construct($db) {
        $this->db = $db;
    }

    //RÃ©cupÃ©ration du user par username pour le login
    public function getUserByEmail(string $email) {
        $getEmailRequest = 'SELECT * FROM user WHERE email = :email';

        $getEmailStmt = $this->db->prepare($getEmailRequest);
        $getEmailStmt->setFetchMode(PDO::FETCH_CLASS, 'User');
        $getEmailStmt->execute ([
            //strtolower me retourne une nouvelle variable mais en minuscule
            'email' => strtolower($email)
        ]);

        return $getEmailStmt->fetch();
    }

    //RÃ©cupÃ©ration du user par username pour le login
    public function getUserByUsername(string $name) {
        $getUserRequest = 'SELECT * FROM user WHERE username = :name';

        $getUserlStmt = $this->db->prepare($getUserRequest);
        $getUserlStmt->setFetchMode(PDO::FETCH_CLASS, 'User');
        $getUserlStmt->execute ([
            //strtolower me retourne une nouvelle variable mais en minuscule
            'name' => strtolower($name)
        ]);

        return $getUserlStmt->fetch();
    }

    //RÃ©cupÃ©ration des users par id
    public function getUserById(int $id) {

        $getUserRequest = 'SELECT * FROM user WHERE id = :id';

        $getUserStmt = $this->db->prepare($getUserRequest);
        $getUserStmt->setFetchMode(PDO::FETCH_CLASS, 'User');
        $getUserStmt->execute( [
                'id' => $id
            ]);

        return $getUserStmt->fetch();
    }

    //RÃ©cupÃ©ration de tous les users
    public function findAll() {

        $findAllRequest = 'SELECT * FROM user';

        $findAllStmt = $this->db->prepare($findAllRequest);
        $findAllStmt->setFetchMode(PDO::FETCH_CLASS, 'User');
        $findAllStmt->execute();

        return $findAllStmt->fetchAll();
    }

    //CrÃ©ation d'un user
    public function createUser(User $user) {

        $createUserRequest = 'INSERT INTO user (username, email, password) VALUES (:username, :email, :password)';

        $createuserStmt = $this->db->prepare($createUserRequest);
        $createuserStmt->execute ([
            'username' => strtolower($user->getUsername()),
            'email' => $user->getEmail(),
            //On encrypte le PWD avant de le stocker
            'password' => password_hash($user->getPassword(), PASSWORD_DEFAULT)
        ]);
    }

    // Update d'un profil user
    public function updateUser(User $user): void {
        // On prÃ©pare les paramÃ¨tres communs
        $params = [
            'id'       => $user->getId(),
            'username' => strtolower($user->getUsername()),
            'email'    => $user->getEmail(),
        ];

        // Si un nouveau mot de passe est fourni â†’ on le hash et on l'update
        if ($user->getPassword() !== null && $user->getPassword() !== '') {
            $sql = 'UPDATE user 
                    SET username = :username, email = :email, password = :password
                    WHERE id = :id';

            $params['password'] = password_hash($user->getPassword(), PASSWORD_DEFAULT);
        } else {
            // Sinon, on ne touche pas au mot de passe
            $sql = 'UPDATE user 
                    SET username = :username, email = :email
                    WHERE id = :id';
        }

        $stmt = $this->db->prepare($sql);
        $stmt->execute($params);
    }

    //update image d'un user
    public function updateUserImage(int $userId, string $imagePath): void {
    $sql = 'UPDATE user SET image = :image WHERE id = :id';

    $stmt = $this->db->prepare($sql);
    $stmt->execute([
        'image' => $imagePath,
        'id'    => $userId,
    ]);
}

}

?>

===============================================
File: models/conversationModel.php
===============================================

<?php

class Conversation implements JsonSerializable
{
    private $id;
    private $created_at;

    public function getId()
    {
        return $this->id;
    }

    public function setId($id)
    {
        return $this->id = $id;
    }

    public function getCreatedAt()
    {
        return $this->created_at;
    }

    public function setCreatedAt($created_at)
    {
        return $this->created_at = $created_at;
    }

    public function jsonSerialize(): array
    {
        return [
            'id'         => $this->id,
            'created_at' => $this->created_at,
        ];
    }
}
?>


===============================================
File: models/livreModel.php
===============================================

<?php

    class Livre implements JsonSerializable {

        private $id;
        private $titre;
        private $auteur;
        private $image;
        private $description;
        private $dispo;
        private $user_id;
        private $user_name;

        public function getId() {
            return $this->id;
        } 

        public function setId($id) {
            return $this->id = $id;
        }

        public function getTitre() {
            return $this->titre;
        }

        public function setTitre($titre) {
            return $this->titre = $titre;
        }

        public function getAuteur() {
            return $this->auteur;
        }

        public function setAuteur($auteur) {
            return $this->auteur = $auteur;
        }

        public function getImage() {
            return $this->image;
        }

        public function setImage($image) {
            return $this->image = $image;
        }

        public function getDescription() {
            return $this->description;
        }

        public function setDescription($description) {
            return $this->description = $description;
        }

        public function getDispo() {
            return $this->dispo;
        }

        public function setDispo($dispo) {
            return $this->dispo = $dispo;
        }

        public function getUserId() {
            return $this->user_id;
        } 

        public function setUserId($user_id) {
            return $this->user_id = $user_id;
        }

        public function getUserName() {
            return $this->user_name;
        } 

        public function setUserName($userName) {
            return $this->user_name = $userName;
        }

        //CrÃ©ation d'un tableau associatif pour la conversion en JSON
        //json_encode ne sait pas comment convertir un objet en JSON
        public function jsonSerialize(): array {
            return [
                'id' => $this->id,
                'titre' => $this->titre,
                'auteur' => $this->auteur,
                'image' => $this->image,
                'description' => $this->description,
                'dispo' => $this->dispo,
                'user_id' => $this->user_id,
                'user_name' => $this->user_name
            ];
        }
    }

?>

===============================================
File: models/messageModel.php
===============================================

<?php

    class Message implements JsonSerializable {

        private $id;
        private $sender_id;
        private $conversation_id;
        private $content;
        private $created_at;
        private $read_at;

        public function getId() {
            return $this->id;
        }

        public function setId($id) {
            return $this->id = $id;
        }

        public function getSenderId() {
            return $this->sender_id;
        }

        public function setSenderId($sender_id) {
            return $this->sender_id = $sender_id;
        }

        public function getConversationId() {
            return $this->conversation_id;
        }

        public function setConversationId($conversation_id) {
            return $this->conversation_id = $conversation_id;
        }

        public function getContent() {
            return $this->content;
        }

        public function setContent($content) {
            return $this->content = $content;
        }

        public function getCreatedAt($created_at) {
            return $this->created_at;
        }

        public function setCreatedAt($created_at) {
            return $this->created_at = $created_at;
        }

        public function getReadAt($read_at) {
            return $this->read_at;
        }

        public function setReadAt($read_at) {
            return $this->read_at = $read_at;
        }

        //CrÃ©ation d'un tableau associatif pour la conversion en JSON
        //json_encode ne sait pas comment convertir un objet en JSON
        public function jsonSerialize(): array {
            return [
                'id' => $this->id,
                'sender_id' => $this->sender_id,
                'conversation_id' => $this->conversation_id,
                'content' => $this->content,
                'created_at' => $this->created_at,
                'read_at' => $this->read_at
            ];
        }

    }
?>

===============================================
File: models/userModel.php
===============================================

<?php

    class User implements JsonSerializable {

        private $id;
        private $username;
        private $email;
        private $password;
        private $image;
        private $created_at;
        // TODO -> ajouter les champs de la DB manquant et lÃ©es mettre dans le JSON_SERIALIZABLE


        public function getId() {
            return $this->id;
        }

        public function setId($id) {
            return $this->id = $id;
        }

        public function getUsername() {
            return $this->username;
        }

        public function setUsername($username) {
            return $this->username = $username;
        }

        public function getEmail() {
            return $this->email;
        }

        public function setEmail($email) {
            return $this->email = $email;
        }

        public function getPassword() {
            return $this->password;
        }

        public function setPassword($password) {
            return $this->password = $password;
        }

        public function getImage() {
            return $this->image;
        }

        public function setImage($image) {
            return $this->image = $image;
        }

        public function getCreatedAt() {
            return $this->created_at;
        }

        public function setCreatedAt($created_at) {
            return $this->created_at = $created_at;
        }
        //CrÃ©ation d'un tableau associatif pour la conversion en JSON
        //json_encode ne sait pas comment convertir un objet en JSON
        public function jsonSerialize(): array {
            return [
                'id' => $this->id,
                'user_name' => $this->username,
                'email' => $this->email,
                'image' => $this->image,
                'created_at' => $this->created_at
            ];
        }
    }
?>

===============================================
File: services/books.js
===============================================

export const getAllBooks = () => {
  return fetch("api/books.php", {
    method: "GET",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
  }).then((response) => response.json());
};

export const getBookById = (id) => {
  return fetch("api/books.php?id=" + id, {
    method: "GET",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
  }).then((response) => response.json());
};

export const getBookUserById = (id) => {
  return fetch("api/books.php?user_id=" + id, {
    method: "GET",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
  }).then((response) => response.json());
};


===============================================
File: services/conversations.js
===============================================

export const getAllConversations = () => {
  return fetch("api/conversations.php", {
    method: "GET",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
  }).then((response) => response.json());
};

export const getAllMessagesForConversation = (id) => {
  return fetch("api/conversations.php?conversation_id=" + id, {
    method: "GET",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
  }).then((response) => response.json());
};

export const getAllParticipantsByConversationId = (id) => {
  return fetch(
    "api/conversations.php?conversation_id=" + id + "&participants=true",
    {
      method: "GET",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
    }
  ).then((response) => response.json());
};

export const createConversationWithUserId = (id) => {
  const body = new URLSearchParams();
  body.append("user_id", id);

  return fetch("api/conversations.php", {
    method: "POST",
    body,
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
  }).then((response) => response.json());
};

export const createMessageForConversation = (conversationId, message) => {
  const body = new URLSearchParams();
  body.append("conversation_id", conversationId);
  body.append("content", message);

  return fetch("api/conversations.php", {
    method: "POST",
    body,
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
  }).then((response) => response.json());
};


===============================================
File: services/createAccount.js
===============================================

export const createAccount = (username, email, password) => {
  const body = new URLSearchParams();
  body.append("username", username);
  body.append("email", email);
  body.append("password", password);

  return fetch("api/user.php", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body,
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};


===============================================
File: services/login.js
===============================================

export const login = (email, password) => {
  const body = new URLSearchParams();
  body.append("email", email);
  body.append("password", password);

  return fetch("api/login.php", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body,
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};

export const getConnectedUser = () => {
  return fetch("api/login.php", {
    method: "GET",
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};


===============================================
File: services/profile.js
===============================================

export const getConnectedUser = () => {
  return fetch("api/profile.php", {
    method: "GET",
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};

export const updateUser = (email, password, username) => {
  const body = new URLSearchParams();
  body.append("email", email);
  body.append("username", username);

  if (password.trim() !== "") {
    body.append("password", password);
  }

  return fetch("api/user.php", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body,
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};

export const updateBook = (id, titre, auteur, image, description, dispo) => {
  const body = new URLSearchParams();
  body.append("action", "update");
  body.append("id", id);
  body.append("titre", titre);
  body.append("auteur", auteur);
  body.append("image", image);
  body.append("description", description);
  body.append("dispo", dispo);

  return fetch("api/books.php", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body,
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};

export const deleteBook = (id) => {
  const body = new URLSearchParams();
  body.append("action", "delete");
  body.append("id", id);

  return fetch("api/books.php", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body,
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};

export const getUserBooks = (userId = null) => {
  const url = userId
    ? `api/books.php?user_id=${encodeURIComponent(userId)}`
    : "api/books.php";

  return fetch(url, {
    method: "GET",
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};

export const createBook = (
  titre,
  auteur,
  description,
  dispo = "1",
  imageFile = null
) => {
  const formData = new FormData();
  formData.append("titre", titre);
  formData.append("auteur", auteur);
  formData.append("description", description);
  formData.append("dispo", dispo);

  if (imageFile) {
    formData.append("image", imageFile);
  }

  return fetch("api/books.php", {
    method: "POST",
    body: formData,
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};

export const getBookById = (id) => {
  return fetch(`api/books.php?id=${encodeURIComponent(id)}`, {
    method: "GET",
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};

export const getUserById = (id) => {
  return fetch(`api/user.php?id=${encodeURIComponent(id)}`, {
    method: "GET",
  }).then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  });
};


===============================================
File: templates/footer.php
===============================================

    </main>
    <footer>
        <ul>
            <li>Politique de confidentialitÃ©</li>
            <li>Mentions lÃ©gales</li>
            <li>Tom Troc&copy;</li>
        </ul>
    </footer>
</body>
</html>

===============================================
File: templates/header.php
===============================================

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TomTroc</title>
    <link rel="stylesheet" href="styles.css" />
    <script type="module">
        import { getConnectedUser } from './services/profile.js';

        document.addEventListener("DOMContentLoaded", () => {
            //RÃ©cupÃ©ration de l'utilisateur connectÃ©
            getConnectedUser()
            .then((user) => {
                console.log(user);
                if(user) {
                    document.getElementById("logout-button").style.display = 'flex';
                } else {
                    document.getElementById("login-button").style.display = 'flex';
                }
            })
            .catch(() => {
                document.getElementById("login-button").style.display = 'flex';
            });
        });
    </script>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li>
                    <a href="./">
                        <img src="assets/logo.png" alt="Logo Tom Troc" />
                    </a>
                </li>
                <li><a href="./" <?php echo isset($selectedMenu) && $selectedMenu === 'home' ? 'class="active"' : ''; ?>>Accueil</a></li>
                <li><a href="books.php" <?php echo isset($selectedMenu) && $selectedMenu === 'book' ? 'class="active"' : ''; ?>>Nos livres Ã  l'Ã©change</a></li>
            </ul>
            <ul>
                <li><a href="messages.php" <?php echo isset($selectedMenu) && $selectedMenu === 'message' ? 'class="active"' : ''; ?>>Messagerie</a></li>
                <li><a href="account.php" <?php echo isset($selectedMenu) && $selectedMenu === 'account' ? 'class="active"' : ''; ?>>Mon compte</a></li>

                <li id="logout-button"><a href="logout.php" class="logout">DÃ©connexion</a></li>
                <li id="login-button"><a href="login.php" <?php echo isset($selectedMenu) && $selectedMenu === 'login' ? 'class="active"' : ''; ?>>Connexion</a></li>
            </ul>
        </nav>
    </header>
    <main>
